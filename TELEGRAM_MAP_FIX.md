# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –≤ Telegram WebApp

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ö–∞—Ä—Ç–∞ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –≤ Telegram WebApp –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Content Security Policy (CSP). JSONP –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å, —Ç–∞–∫ –∫–∞–∫ Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å script —Ç–µ–≥–∏.

### –ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ –≤ Telegram:

1. **CSP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - Telegram WebApp –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ `<script>` —Ç–µ–≥–æ–≤
2. **JSONP —Ç—Ä–µ–±—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤** - `wialonJsonpService` —Å–æ–∑–¥–∞–≤–∞–ª script —Ç–µ–≥–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
3. **–†–∞–±–æ—Ç–∞–ª–æ —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ** - –æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä –Ω–µ –∏–º–µ–µ—Ç —Ç–∞–∫–∏—Ö —Å—Ç—Ä–æ–≥–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

## ‚ú® –†–µ—à–µ–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

### 1. **Telegram WebApp** ‚Üí Backend API

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π REST API —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
- –†–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–π —Å—Ä–µ–¥–µ —Å CSP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏

### 2. **–û–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä** ‚Üí JSONP (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)

- –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ JSONP –∑–∞–ø—Ä–æ—Å—ã
- –ë—ã—Å—Ç—Ä–µ–µ, –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ backend
- –û–±—Ö–æ–¥–∏—Ç CORS –Ω–∞–ø—Ä—è–º—É—é

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### Backend (–Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã)

#### 1. `/backend/src/controllers/trackingController.ts`

```typescript
// –ü—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
// –î–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
export class TrackingController {
  static async getVehiclePosition(req: Request, res: Response);
}
```

#### 2. `/backend/src/routes/tracking.ts`

```typescript
// –ü—É–±–ª–∏—á–Ω—ã–µ —Ä–æ—É—Ç—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
// GET /api/tracking/vehicles/:unitId/position
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω `/backend/src/index.ts`

```typescript
// –î–æ–±–∞–≤–ª–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π —Ä–æ—É—Ç
app.use("/api/tracking", trackingRoutes);
```

### Frontend (–Ω–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã)

#### 1. `/frontend/src/services/wialonBackendService.ts` (–Ω–æ–≤—ã–π)

```typescript
// –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Wialon —á–µ—Ä–µ–∑ backend API
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Telegram WebApp
class WialonBackendService {
  async getUnitById(unitId: string): Promise<WialonUnit | null>;
  async getUnitPosition(unitId: string): Promise<VehiclePosition | null>;
}
```

#### 2. `/frontend/src/utils/telegram.ts` (–Ω–æ–≤—ã–π)

```typescript
// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Telegram WebApp
function isTelegramWebApp(): boolean;
function supportsJSONP(): boolean;
function getTelegramWebApp();
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω `/frontend/src/components/VehicleTracker.tsx`

```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
const useBackendAPI = !supportsJSONP();

if (useBackendAPI) {
  // Telegram WebApp ‚Üí Backend API
  const unit = await wialonBackendService.getUnitById(wialonUnitId);
} else {
  // –û–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä ‚Üí JSONP
  const vehicles = await wialonJsonpService.getVehicles();
}
```

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –í Telegram WebApp:

```
Telegram WebApp
    ‚Üì
VehicleTracker (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç Telegram)
    ‚Üì
wialonBackendService
    ‚Üì
Backend API /api/tracking/vehicles/:id/position
    ‚Üì
wialonService (–Ω–∞ backend)
    ‚Üì
Wialon GPS API
```

### –í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ:

```
–ë—Ä–∞—É–∑–µ—Ä (http://localhost:3003)
    ‚Üì
VehicleTracker (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä)
    ‚Üì
wialonJsonpService
    ‚Üì
JSONP –∑–∞–ø—Ä–æ—Å—ã –Ω–∞–ø—Ä—è–º—É—é
    ‚Üì
Wialon GPS API
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—É–±–ª–∏—á–Ω—ã–π tracking API:

- ‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏—é —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
- ‚úÖ –ù–µ –¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∏–ª–∏ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º
- ‚úÖ Rate limiting –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ó–∞—â–∏—â–µ–Ω–Ω—ã–π admin API:

- üîê –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- üîê –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º Wialon
- üîê –ú–∞—Ä—à—Ä—É—Ç: `/api/wialon/*`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç –≤ Telegram WebApp:

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ backend –∏ frontend
cd backend && npm run dev
cd frontend && npm run dev

# 2. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç
# 3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
# 4. –ö–∞—Ä—Ç–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ Backend API
```

### 2. –¢–µ—Å—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ:

```bash
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3003/status/[booking_id]
# 2. –ö–∞—Ä—Ç–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ JSONP
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:

```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# Telegram: "Loading position for unit X via Backend API..."
# –ë—Ä–∞—É–∑–µ—Ä: "Loading position for unit X via JSONP..."
```

## üìä API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–π Tracking API

#### `GET /api/tracking/vehicles/:unitId/position`

–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `unitId` - ID –µ–¥–∏–Ω–∏—Ü—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –≤ Wialon

**–û—Ç–≤–µ—Ç:**

```json
{
  "success": true,
  "data": {
    "id": "12345",
    "name": "–ê–≤—Ç–æ–±—É—Å 01",
    "position": {
      "lat": 41.311151,
      "lng": 69.279737,
      "speed": 45,
      "course": 90,
      "time": 1697234567
    },
    "status": "moving"
  }
}
```

**–°—Ç–∞—Ç—É—Å—ã:**

- `moving` - –í –¥–≤–∏–∂–µ–Ω–∏–∏ (—Å–∫–æ—Ä–æ—Å—Ç—å > 5 –∫–º/—á)
- `stopped` - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Å–∫–æ—Ä–æ—Å—Ç—å ‚â§ 5 –∫–º/—á)
- `offline` - –û—Ñ—Ñ–ª–∞–π–Ω (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö > 10 –º–∏–Ω—É—Ç)

## üé® UI/UX

–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

- ‚úÖ –ö–∞—Ä—Ç–∞ –≤—ã–≥–ª—è–¥–∏—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é, —Å–∫–æ—Ä–æ—Å—Ç—å, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram –∏ –±—Ä–∞—É–∑–µ—Ä–µ

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Telegram WebApp:

- ‚è±Ô∏è –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: ~1-2 —Å–µ–∫
- üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ~0.5-1 —Å–µ–∫
- üì° –¢—Ä–∞—Ñ–∏–∫: –º–µ–Ω—å—à–µ (JSON –≤–º–µ—Å—Ç–æ JSONP)

### –ë—Ä–∞—É–∑–µ—Ä:

- ‚è±Ô∏è –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: ~1-2 —Å–µ–∫
- üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ~0.5-1 —Å–µ–∫
- üì° –¢—Ä–∞—Ñ–∏–∫: —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ —Ä–∞–Ω—å—à–µ

## ‚úÖ –ò—Ç–æ–≥

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. ‚úÖ –ö–∞—Ä—Ç–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram WebApp
2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã (Telegram/–±—Ä–∞—É–∑–µ—Ä)
3. ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π API –¥–ª—è tracking –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å JSONP –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

- ‚úÖ Telegram WebApp - –∫–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Backend API
- ‚úÖ –û–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä - –∫–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JSONP
- ‚úÖ –û–±–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: `/status/:bookingId` –∏ `/tracking/:bookingId`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π tracking API –Ω–µ –¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é
- ‚úÖ Admin API –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞—â–∏—â–µ–Ω–Ω—ã–º
- ‚úÖ Rate limiting –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—Å–∞–º

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **Backend –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω** - Telegram WebApp –∏—Å–ø–æ–ª—å–∑—É–µ—Ç backend API
2. **Wialon token** - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `WIALON_TOKEN` —É–∫–∞–∑–∞–Ω –≤ `.env`
3. **CORS** - Backend —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è tracking API
4. **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üîç –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend:**

```bash
tail -f logs/backend.log
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "üìç Public tracking: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è unit X..."
```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:**

```javascript
// Telegram
console.log(window.Telegram?.WebApp); // –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç

// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
// "üöó Loading position for unit X via Backend API..."
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API:**

```bash
curl http://localhost:3001/api/tracking/vehicles/123456/position
```

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –∫–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ Telegram WebApp, –∏ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ! üöÄ
