<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wialon - –õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .login-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 6px;
      margin: 20px 0;
      border-left: 4px solid #007bff;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #374151;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.success:hover {
      background: #218838;
    }

    .vehicle-list {
      margin-top: 20px;
    }

    .vehicle-item {
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #28a745;
    }

    .vehicle-offline {
      border-left-color: #dc3545;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .warning-block {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }

    .server-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .server-option {
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .server-option:hover {
      background: #f3f4f6;
    }

    .server-option.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîê –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wialon - –õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å</h1>
    <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ Wialon —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è –æ—Ç –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞</p>

    <div class="info-block">
      <strong>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ –ª–æ–≥–∏–Ω—É/–ø–∞—Ä–æ–ª—é:</strong><br>
      ‚úÖ –ù–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã<br>
      ‚úÖ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º<br>
      ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏<br>
      ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏
    </div>

    <!-- –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div class="login-form">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä Wialon:</h3>
      <div class="server-options">
        <div class="server-option active" data-url="http://176.74.220.111">
          HTTP<br><small>176.74.220.111</small>
        </div>
        <div class="server-option" data-url="https://176.74.220.111">
          HTTPS<br><small>176.74.220.111</small>
        </div>
        <div class="server-option" data-url="http://176.74.220.111:8080">
          HTTP:8080<br><small>176.74.220.111:8080</small>
        </div>
        <div class="server-option" data-url="https://hst-api.wialon.com">
          Wialon Hosting<br><small>hst-api.wialon.com</small>
        </div>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div class="login-form">
      <h3>–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ Wialon:</h3>
      <div class="form-group">
        <label for="username">–õ–æ–≥–∏–Ω (–∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):</label>
        <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω" />
      </div>
      <div class="form-group">
        <label for="password">–ü–∞—Ä–æ–ª—å:</label>
        <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å" />
      </div>
    </div>

    <div class="warning-block">
      <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
      –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π.
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <button class="btn" onclick="testLogin()">üîê –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
    <button class="btn" onclick="testServerAvailability()">üåê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    <button class="btn success" onclick="getVehicles()" id="vehiclesBtn" disabled>üöå –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
    <button class="btn" onclick="logout()" id="logoutBtn" disabled>üö™ –í—ã–π—Ç–∏</button>
    <button class="btn" onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>

    <!-- –°—Ç–∞—Ç—É—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="status"></div>
    <div id="results"></div>
    <div id="log"></div>
  </div>

  <script>
    let currentServerUrl = 'http://176.74.220.111';
    let session = null;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞
    document.querySelectorAll('.server-option').forEach(option => {
      option.addEventListener('click', function () {
        document.querySelectorAll('.server-option').forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
        currentServerUrl = this.dataset.url;
        log(`–í—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–µ—Ä: ${currentServerUrl}`, 'info');
      });
    });

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '5px 0';
      logEntry.style.padding = '5px';
      logEntry.style.borderRadius = '3px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    async function makeRequest(svc, params = {}) {
      const baseApiUrl = currentServerUrl.includes('/wialon/ajax.html')
        ? currentServerUrl
        : `${currentServerUrl}/wialon/ajax.html`;

      const url = new URL(baseApiUrl);
      url.searchParams.set('svc', svc);

      if (session) {
        url.searchParams.set('sid', session.sid);
      }

      const body = new URLSearchParams();
      body.append('params', JSON.stringify(params));

      log(`–ó–∞–ø—Ä–æ—Å: ${svc} –∫ ${currentServerUrl}`);
      log(`–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(params)}`);

      try {
        const response = await fetch(url.toString(), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: body.toString()
        });

        log(`–°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        log(`–û—Ç–≤–µ—Ç: ${JSON.stringify(data, null, 2)}`);
        return data;
      } catch (error) {
        log(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
        throw error;
      }
    }

    async function testServerAvailability() {
      log('=== –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò –°–ï–†–í–ï–†–ê ===');
      showStatus('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...', 'loading');

      try {
        const response = await fetch(currentServerUrl, {
          method: 'HEAD',
          mode: 'no-cors'
        });
        log(`‚úÖ –°–µ—Ä–≤–µ—Ä ${currentServerUrl} –¥–æ—Å—Ç—É–ø–µ–Ω`, 'success');
        showStatus(`‚úÖ –°–µ—Ä–≤–µ—Ä ${currentServerUrl} –¥–æ—Å—Ç—É–ø–µ–Ω`, 'success');
      } catch (error) {
        log(`‚ùå –°–µ—Ä–≤–µ—Ä ${currentServerUrl} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`, 'error');
        showStatus(`‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`, 'error');
      }
    }

    async function testLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!username || !password) {
        showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', 'error');
        return;
      }

      log('=== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –í WIALON ===');
      showStatus('üîÑ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...', 'loading');

      try {
        // –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const loginResponse = await makeRequest('core/login', {
          user: username,
          password: password
        });

        if (loginResponse.error) {
          throw new Error(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${loginResponse.error}`);
        }

        session = {
          sid: loginResponse.eid,
          userId: loginResponse.user?.id || 0,
          userName: loginResponse.user?.nm || 'Unknown'
        };

        log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!`, 'success');
        log(`SID: ${session.sid}`, 'success');
        log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName} (ID: ${session.userId})`, 'success');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
        const tzOffset = new Date().getTimezoneOffset() * -60;
        await makeRequest('render/set_locale', {
          tzOffset,
          language: 'ru'
        });

        showStatus(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${session.userName}!`, 'success');

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('vehiclesBtn').disabled = false;
        document.getElementById('logoutBtn').disabled = false;

        log('=== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê ===', 'success');

      } catch (error) {
        showStatus(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
        log(`–û–®–ò–ë–ö–ê: ${error.message}`, 'error');
      }
    }

    async function getVehicles() {
      if (!session) {
        showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
        return;
      }

      log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –°–ü–ò–°–ö–ê –¢–†–ê–ù–°–ü–û–†–¢–ê ===');
      showStatus('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...', 'loading');

      try {
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        const searchResponse = await makeRequest('core/search_items', {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: 0x1,
          from: 0,
          to: 0
        });

        const vehicles = searchResponse.items || [];
        log(`–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${vehicles.length}`, 'success');

        if (vehicles.length === 0) {
          showStatus('‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
          return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–∑–∏—Ü–∏—è—Ö
        const vehicleIds = vehicles.map(v => v.id);
        await makeRequest('core/update_data_flags', {
          spec: vehicleIds.map(id => ({
            type: 'id',
            data: id,
            flags: 0x1 | 0x2
          }))
        });

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        displayVehicles(vehicles);
        showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`, 'success');

      } catch (error) {
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        log(`–û–®–ò–ë–ö–ê: ${error.message}`, 'error');
      }
    }

    function displayVehicles(vehicles) {
      const resultsDiv = document.getElementById('results');

      let html = '<div class="vehicle-list"><h3>üöå –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤:</h3>';

      vehicles.forEach((vehicle, index) => {
        const pos = vehicle.pos;
        const isOnline = pos && (Math.floor(Date.now() / 1000) - pos.t) < 600;
        const speed = pos?.s || 0;
        const status = !isOnline ? '–û—Ñ—Ñ–ª–∞–π–Ω' : speed > 5 ? '–í –¥–≤–∏–∂–µ–Ω–∏–∏' : '–û—Å—Ç–∞–Ω–æ–≤–∫–∞';

        html += `
          <div class="vehicle-item ${!isOnline ? 'vehicle-offline' : ''}">
            <strong>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</strong><br>
            <small>
              ID: ${vehicle.id} | 
              –°—Ç–∞—Ç—É—Å: ${status} | 
              –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á<br>
              ${pos ? `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.y?.toFixed(6)}, ${pos.x?.toFixed(6)}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏'}<br>
              ${pos ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(pos.t * 1000).toLocaleString()}` : ''}
            </small>
          </div>
        `;
      });

      html += '</div>';
      resultsDiv.innerHTML = html;
    }

    async function logout() {
      if (!session) return;

      try {
        await makeRequest('core/logout');
        session = null;

        document.getElementById('vehiclesBtn').disabled = true;
        document.getElementById('logoutBtn').disabled = true;

        showStatus('‚úÖ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
        log('–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');

        document.getElementById('results').innerHTML = '';
      } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${error.message}`, 'error');
      }
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('status').innerHTML = '';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function () {
      log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Wialon.');
      log(`–í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä: ${currentServerUrl}`);
    };
  </script>
</body>

</html>