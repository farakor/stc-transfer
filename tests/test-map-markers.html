<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .map-container {
      height: 400px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      margin: 20px 0;
    }

    .coordinates-list {
      max-height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .coordinate-item {
      padding: 8px;
      margin: 4px 0;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #007bff;
      font-size: 12px;
    }

    .coordinate-item.valid {
      border-left-color: #28a745;
    }

    .coordinate-item.invalid {
      border-left-color: #dc3545;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #dee2e6;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üó∫Ô∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã</h1>
    
    <div class="info-block">
      <strong>üéØ –¶–µ–ª—å:</strong> –í—ã—è—Å–Ω–∏—Ç—å –ø–æ—á–µ–º—É —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ<br>
      <strong>üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º:</strong> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤<br>
      <strong>üîë –¢–æ–∫–µ–Ω:</strong> 85991e5f06896e98fe3c0bd49d2fe6d825770468546E156C3088DF44EB44163B2A478841
    </div>

    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="runMapDiagnostics()">üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç—ã</button>
      <button class="btn" onclick="showTestMap()">üó∫Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div id="status"></div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid" id="statsGrid" style="display: none;">
      <div class="stat-card">
        <div class="stat-number" id="totalVehicles">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="validCoords">0</div>
        <div class="stat-label">–í–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="invalidCoords">0</div>
        <div class="stat-label">–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="markersCreated">0</div>
        <div class="stat-label">–ú–∞—Ä–∫–µ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã</div>
      </div>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div id="mapContainer" class="map-container" style="display: none;"></div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
    <div id="coordinatesList" class="coordinates-list" style="display: none;"></div>

    <div id="log"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const serverHost = 'gps.ent-en.com';
    const token = '85991e5f06896e98fe3c0bd49d2fe6d825770468546E156C3088DF44EB44163B2A478841';
    let session = null;
    let vehicles = [];
    let map = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function updateStats(vehicleData) {
      let validCoords = 0;
      let invalidCoords = 0;
      let markersCreated = 0;

      vehicleData.forEach(vehicle => {
        const pos = vehicle.pos;
        if (pos && pos.y !== 0 && pos.x !== 0 && 
            pos.y >= -90 && pos.y <= 90 && 
            pos.x >= -180 && pos.x <= 180) {
          validCoords++;
          markersCreated++;
        } else {
          invalidCoords++;
        }
      });

      document.getElementById('totalVehicles').textContent = vehicleData.length;
      document.getElementById('validCoords').textContent = validCoords;
      document.getElementById('invalidCoords').textContent = invalidCoords;
      document.getElementById('markersCreated').textContent = markersCreated;
      document.getElementById('statsGrid').style.display = 'grid';
    }

    function displayCoordinates(vehicleData) {
      const coordsList = document.getElementById('coordinatesList');
      let html = '<h4>üìç –ê–Ω–∞–ª–∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</h4>';

      vehicleData.forEach((vehicle, index) => {
        const pos = vehicle.pos;
        const isValid = pos && pos.y !== 0 && pos.x !== 0 && 
                       pos.y >= -90 && pos.y <= 90 && 
                       pos.x >= -180 && pos.x <= 180;
        
        const statusClass = isValid ? 'valid' : 'invalid';
        const statusIcon = isValid ? '‚úÖ' : '‚ùå';
        
        html += `
          <div class="coordinate-item ${statusClass}">
            ${statusIcon} <strong>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</strong><br>
            ${pos ? 
              `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.y?.toFixed(6) || 'N/A'}, ${pos.x?.toFixed(6) || 'N/A'}` : 
              '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏'}<br>
            ${pos ? `–í—Ä–µ–º—è: ${new Date(pos.t * 1000).toLocaleString()}` : '–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏'}<br>
            ${pos ? `–°–∫–æ—Ä–æ—Å—Ç—å: ${pos.s || 0} –∫–º/—á` : '–ù–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏'}
          </div>
        `;
      });

      coordsList.innerHTML = html;
      coordsList.style.display = 'block';
    }

    // JSONP –∑–∞–ø—Ä–æ—Å
    function makeJsonpRequest(service, params, sid) {
      return new Promise((resolve, reject) => {
        const callbackName = 'wialonCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        window[callbackName] = function(data) {
          try {
            if (data.error) {
              reject(new Error(`Wialon API Error: ${data.error}`));
            } else {
              resolve(data);
            }
          } catch (error) {
            reject(error);
          } finally {
            delete window[callbackName];
            const script = document.getElementById(`jsonp-${callbackName}`);
            if (script) script.remove();
          }
        };

        let url = `https://${serverHost}/wialon/ajax.html?svc=${service}`;
        if (sid) url += `&sid=${sid}`;
        url += `&params=${encodeURIComponent(JSON.stringify(params))}`;
        url += `&callback=${callbackName}`;

        const script = document.createElement('script');
        script.id = `jsonp-${callbackName}`;
        script.src = url;
        
        script.onerror = () => {
          delete window[callbackName];
          reject(new Error('JSONP request failed'));
        };

        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script) script.remove();
            reject(new Error('JSONP timeout'));
          }
        }, 10000);

        document.head.appendChild(script);
      });
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    async function login() {
      log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...');
      try {
        const response = await makeJsonpRequest('token/login', { token: token });
        session = {
          sid: response.eid,
          userName: response.user?.nm || 'Unknown'
        };
        log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! SID: ${session.sid}`, 'success');
        return session;
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
        throw error;
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
    async function getVehiclesWithAnalysis() {
      log('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');
      try {
        const response = await makeJsonpRequest('core/search_items', {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: 1,
          from: 0,
          to: 0
        }, session.sid);

        vehicles = response.items || [];
        log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${vehicles.length}`, 'success');
        
        // –ê–Ω–∞–ª–∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        let validCoords = 0;
        let invalidCoords = 0;
        let noPosition = 0;
        
        vehicles.forEach(vehicle => {
          const pos = vehicle.pos;
          if (!pos) {
            noPosition++;
            log(`‚ö†Ô∏è ${vehicle.nm || vehicle.id}: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏`, 'error');
          } else if (pos.y === 0 && pos.x === 0) {
            invalidCoords++;
            log(`‚ö†Ô∏è ${vehicle.nm || vehicle.id}: –ù—É–ª–µ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (0, 0)`, 'error');
          } else if (pos.y < -90 || pos.y > 90 || pos.x < -180 || pos.x > 180) {
            invalidCoords++;
            log(`‚ö†Ô∏è ${vehicle.nm || vehicle.id}: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (${pos.y}, ${pos.x})`, 'error');
          } else {
            validCoords++;
            log(`‚úÖ ${vehicle.nm || vehicle.id}: –í–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (${pos.y.toFixed(6)}, ${pos.x.toFixed(6)})`, 'success');
          }
        });
        
        log(`üìä –ê–Ω–∞–ª–∏–∑: –í—Å–µ–≥–æ ${vehicles.length}, –í–∞–ª–∏–¥–Ω—ã—Ö ${validCoords}, –ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö ${invalidCoords}, –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏ ${noPosition}`, 'info');
        
        return vehicles;
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
        throw error;
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏
    function createMapWithMarkers(vehicleData) {
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.style.display = 'block';
      mapContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
      map = L.map(mapContainer).setView([41.2995, 69.2401], 10); // –¢–∞—à–∫–µ–Ω—Ç

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      let markersAdded = 0;
      const validVehicles = [];

      vehicleData.forEach(vehicle => {
        const pos = vehicle.pos;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        if (pos && pos.y !== 0 && pos.x !== 0 && 
            pos.y >= -90 && pos.y <= 90 && 
            pos.x >= -180 && pos.x <= 180) {
          
          validVehicles.push(vehicle);
          
          // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
          const marker = L.marker([pos.y, pos.x]).addTo(map);
          
          // –î–æ–±–∞–≤–ª—è–µ–º popup
          const now = Math.floor(Date.now() / 1000);
          const isOnline = (now - pos.t) < 600; // 10 –º–∏–Ω—É—Ç
          const speed = pos.s || 0;
          const status = isOnline ? (speed > 5 ? '–í –¥–≤–∏–∂–µ–Ω–∏–∏' : '–û—Å—Ç–∞–Ω–æ–≤–∫–∞') : '–û—Ñ—Ñ–ª–∞–π–Ω';
          
          marker.bindPopup(`
            <div>
              <h4>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</h4>
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${status}</p>
              <p><strong>–°–∫–æ—Ä–æ—Å—Ç—å:</strong> ${speed} –∫–º/—á</p>
              <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${pos.y.toFixed(6)}, ${pos.x.toFixed(6)}</p>
              <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${new Date(pos.t * 1000).toLocaleString()}</p>
            </div>
          `);
          
          markersAdded++;
        }
      });

      log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ: ${markersAdded}`, 'success');

      // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞—Ö
      if (validVehicles.length > 0) {
        const group = new L.featureGroup(map._layers);
        if (Object.keys(group._layers).length > 0) {
          map.fitBounds(group.getBounds().pad(0.1));
        }
        log(`üó∫Ô∏è –ö–∞—Ä—Ç–∞ –æ—Ç—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ ${validVehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö`, 'success');
      } else {
        log(`‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã`, 'error');
      }

      return markersAdded;
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    async function runMapDiagnostics() {
      log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ê–†–¢–´ ===');
      showStatus('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤...', 'loading');

      try {
        // –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        await login();
        
        // –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —Å –∞–Ω–∞–ª–∏–∑–æ–º
        const vehicleData = await getVehiclesWithAnalysis();
        
        // –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        updateStats(vehicleData);
        
        // –®–∞–≥ 4: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        displayCoordinates(vehicleData);
        
        // –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
        const markersCreated = createMapWithMarkers(vehicleData);
        
        if (markersCreated > 0) {
          showStatus(`‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–æ–∑–¥–∞–Ω–æ ${markersCreated} –º–∞—Ä–∫–µ—Ä–æ–≤ –∏–∑ ${vehicleData.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞`, 'success');
          log(`üéâ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –£–°–ü–ï–®–ù–ê: ${markersCreated} –º–∞—Ä–∫–µ—Ä–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ`, 'success');
        } else {
          showStatus(`‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞–π–¥–µ–Ω (${vehicleData.length}), –Ω–æ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è`, 'error');
          log(`‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç`, 'error');
        }
        
      } catch (error) {
        showStatus(`‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: ${error.message}`, 'error');
        log(`üí• –û–®–ò–ë–ö–ê –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò: ${error.message}`, 'error');
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É —Å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏
    function showTestMap() {
      log('–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã —Å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏...');
      
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.style.display = 'block';
      mapContainer.innerHTML = '';

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
      map = L.map(mapContainer).setView([41.2995, 69.2401], 12);

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –¢–∞—à–∫–µ–Ω—Ç–µ
      const testMarkers = [
        { lat: 41.2995, lng: 69.2401, name: '–¢–µ—Å—Ç 1 - –¶–µ–Ω—Ç—Ä' },
        { lat: 41.3111, lng: 69.2797, name: '–¢–µ—Å—Ç 2 - –ß–æ—Ä—Å—É' },
        { lat: 41.2646, lng: 69.2163, name: '–¢–µ—Å—Ç 3 - –ê—ç—Ä–æ–ø–æ—Ä—Ç' },
        { lat: 41.3193, lng: 69.2491, name: '–¢–µ—Å—Ç 4 - –ê–º–∏—Ä –¢–µ–º—É—Ä' }
      ];

      testMarkers.forEach(marker => {
        L.marker([marker.lat, marker.lng])
          .addTo(map)
          .bindPopup(`<h4>${marker.name}</h4><p>–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä</p>`);
      });

      log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${testMarkers.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤`, 'success');
      showStatus(`‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å ${testMarkers.length} –º–∞—Ä–∫–µ—Ä–∞–º–∏`, 'success');
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      document.getElementById('statsGrid').style.display = 'none';
      document.getElementById('coordinatesList').style.display = 'none';
      document.getElementById('mapContainer').style.display = 'none';
      
      if (map) {
        map.remove();
        map = null;
      }
      
      session = null;
      vehicles = [];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function() {
      log('üó∫Ô∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã –≥–æ—Ç–æ–≤–∞!');
      log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 30)}...`);
      log(`–°–µ—Ä–≤–µ—Ä: ${serverHost}`);
      log('–ù–∞–∂–º–∏—Ç–µ "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç—ã" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º');
    };
  </script>
</body>

</html>
