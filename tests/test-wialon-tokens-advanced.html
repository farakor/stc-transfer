<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç —Ç–æ–∫–µ–Ω–æ–≤ Wialon API - 176.74.220.111</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .token-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }

    .token-card.testing {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .token-card.success {
      border-color: #28a745;
      background: #d4edda;
    }

    .token-card.error {
      border-color: #dc3545;
      background: #f8d7da;
    }

    .token-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 10px;
    }

    .token-name {
      font-weight: 600;
      color: #495057;
    }

    .token-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #f8f9fa;
      color: #6c757d;
    }

    .status-testing {
      background: #cce5ff;
      color: #004085;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .token-value {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      color: #6c757d;
      word-break: break-all;
      margin: 5px 0;
    }

    .token-result {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .form-group {
      margin: 15px 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group textarea {
      height: 80px;
      resize: vertical;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
    }

    .vehicle-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .vehicle-item {
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #28a745;
    }

    .vehicle-offline {
      border-left-color: #dc3545;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #0056b3);
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîë –¢–µ—Å—Ç —Ç–æ–∫–µ–Ω–æ–≤ Wialon API</h1>
    <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É 176.74.220.111</p>

    <div class="info-block">
      <strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
      1. –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ —Ç–æ–∫–µ–Ω—ã –≤ –ø–æ–ª–µ –Ω–∏–∂–µ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)<br>
      2. –ù–∞–∂–º–∏—Ç–µ "üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã"<br>
      3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç —Ä–∞–±–æ—á–∏–π —Ç–æ–∫–µ–Ω<br>
      4. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω —Ä–∞–±–æ—á–∏–π —Ç–æ–∫–µ–Ω - –∑–∞–≥—Ä—É–∑–∏—Ç —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ -->
    <div class="form-group">
      <label>–¢–æ–∫–µ–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É):</label>
      <textarea id="tokensInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ —Ç–æ–∫–µ–Ω—ã –∑–¥–µ—Å—å, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏...">85991e5f06896e98fe3c0bd49d2fe6d8180CC6E50B57B93D4DEBC803DCA10911F8194C4C
85991e5f06896e98fe3c0bd49d2fe6d81E788605DF95583FD8DDBFFC265EBDE983728755
85991e5f06896e98fe3c0bd49d2fe6d81F89022B622B2C29F032B733A970E75BD5442A89
85991e5f06896e98fe3c0bd49d2fe6d82EF1B79878B3945A64C4E9CF0B89A97BBE9859DC
85991e5f06896e98fe3c0bd49d2fe6d87952655C715C1EEB7D785AECF9E97D45C2365196
85991e5f06896e98fe3c0bd49d2fe6d88A480A15648C17B4F9820C17D612D39FF0416A36
85991e5f06896e98fe3c0bd49d2fe6d8EC2B0F5F2A7A963F0EC0B869EB87FF8188C6EE8D
85991e5f06896e98fe3c0bd49d2fe6d8FB33DD1867560C348D1E2840BE0227089280C386</textarea>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="testAllTokens()">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã</button>
      <button class="btn" onclick="testSingleToken()">üîç –¢–µ—Å—Ç –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞</button>
      <button class="btn" onclick="getVehicles()" id="vehiclesBtn" disabled>üöå –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="progress-bar" style="display: none;" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div id="progressText" style="text-align: center; font-size: 12px; color: #666;"></div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="status"></div>

    <!-- –°–µ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ -->
    <div class="token-grid" id="tokenGrid"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="results"></div>

    <!-- –õ–æ–≥–∏ -->
    <div id="log"></div>
  </div>

  <script>
    const baseUrl = 'http://176.74.220.111/wialon/ajax.html';
    let workingToken = null;
    let session = null;
    let vehicles = [];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function updateProgress(current, total, text) {
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      progressBar.style.display = 'block';
      const percentage = (current / total) * 100;
      progressFill.style.width = `${percentage}%`;
      progressText.textContent = `${text} (${current}/${total})`;
    }

    function hideProgress() {
      document.getElementById('progressBar').style.display = 'none';
      document.getElementById('progressText').textContent = '';
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–∫–µ–Ω–∞
    function createTokenCard(token, index) {
      const tokenCard = document.createElement('div');
      tokenCard.className = 'token-card';
      tokenCard.id = `token-${index}`;

      tokenCard.innerHTML = `
        <div class="token-header">
          <div class="token-name">–¢–æ–∫–µ–Ω ${index + 1}</div>
          <div class="token-status status-pending" id="status-${index}">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="token-value">${token.substring(0, 30)}...${token.substring(token.length - 10)}</div>
        <div class="token-result" id="result-${index}" style="display: none;"></div>
      `;

      return tokenCard;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–∫–µ–Ω–∞
    function updateTokenStatus(index, status, message = '') {
      const card = document.getElementById(`token-${index}`);
      const statusEl = document.getElementById(`status-${index}`);
      const resultEl = document.getElementById(`result-${index}`);

      card.className = `token-card ${status}`;
      statusEl.className = `token-status status-${status}`;

      switch (status) {
        case 'testing':
          statusEl.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
          break;
        case 'success':
          statusEl.textContent = '–†–∞–±–æ—Ç–∞–µ—Ç!';
          break;
        case 'error':
          statusEl.textContent = '–û—à–∏–±–∫–∞';
          break;
      }

      if (message) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = message;
      }
    }

    // –¢–µ—Å—Ç –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
    async function testToken(token) {
      try {
        const response = await fetch(`${baseUrl}?svc=token/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `params=${JSON.stringify({ token: token })}`
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(`Wialon Error: ${data.error}`);
        }

        return {
          success: true,
          data: data,
          session: {
            sid: data.eid,
            userId: data.user?.id || 0,
            userName: data.user?.nm || 'Unknown'
          }
        };
      } catch (error) {
        return {
          success: false,
          error: error.message
        };
      }
    }

    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤
    async function testAllTokens() {
      const tokensText = document.getElementById('tokensInput').value.trim();
      if (!tokensText) {
        showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
        return;
      }

      const tokens = tokensText.split('\n').filter(t => t.trim()).map(t => t.trim());

      if (tokens.length === 0) {
        showStatus('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤', 'error');
        return;
      }

      log('=== –ù–ê–ß–ê–õ–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –¢–û–ö–ï–ù–û–í ===');
      showStatus(`üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${tokens.length} —Ç–æ–∫–µ–Ω–æ–≤...`, 'loading');

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤
      const tokenGrid = document.getElementById('tokenGrid');
      tokenGrid.innerHTML = '';

      tokens.forEach((token, index) => {
        const card = createTokenCard(token, index);
        tokenGrid.appendChild(card);
      });

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω
      for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        updateProgress(i + 1, tokens.length, `–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ ${i + 1}`);
        updateTokenStatus(i, 'testing');

        log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ ${i + 1}/${tokens.length}: ${token.substring(0, 20)}...`);

        const result = await testToken(token);

        if (result.success) {
          updateTokenStatus(i, 'success', `
            <strong>‚úÖ –¢–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç!</strong><br>
            SID: ${result.session.sid}<br>
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${result.session.userName}
          `);

          log(`‚úÖ –¢–æ–∫–µ–Ω ${i + 1} —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${result.session.userName}`, 'success');

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–±–æ—á–∏–π —Ç–æ–∫–µ–Ω
          workingToken = token;
          session = result.session;

          showStatus(`‚úÖ –ù–∞–π–¥–µ–Ω —Ä–∞–±–æ—á–∏–π —Ç–æ–∫–µ–Ω ${i + 1}! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${result.session.userName}`, 'success');
          document.getElementById('vehiclesBtn').disabled = false;

          hideProgress();
          return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —Ä–∞–±–æ—á–µ–º —Ç–æ–∫–µ–Ω–µ
        } else {
          updateTokenStatus(i, 'error', `‚ùå ${result.error}`);
          log(`‚ùå –¢–æ–∫–µ–Ω ${i + 1} –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${result.error}`, 'error');
        }

        // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      hideProgress();

      if (!workingToken) {
        showStatus('‚ùå –ù–∏ –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error');
        log('=== –í–°–ï –¢–û–ö–ï–ù–´ –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–´ - –ù–ò –û–î–ò–ù –ù–ï –†–ê–ë–û–¢–ê–ï–¢ ===', 'error');
      }
    }

    // –¢–µ—Å—Ç –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    async function testSingleToken() {
      const tokensText = document.getElementById('tokensInput').value.trim();
      const tokens = tokensText.split('\n').filter(t => t.trim()).map(t => t.trim());

      if (tokens.length === 0) {
        showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω', 'error');
        return;
      }

      const token = tokens[0];
      log(`=== –¢–ï–°–¢ –û–î–ù–û–ì–û –¢–û–ö–ï–ù–ê ===`);
      log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 20)}...`);
      showStatus('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞...', 'loading');

      const result = await testToken(token);

      if (result.success) {
        workingToken = token;
        session = result.session;
        showStatus(`‚úÖ –¢–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${result.session.userName}`, 'success');
        document.getElementById('vehiclesBtn').disabled = false;
        log(`‚úÖ –£—Å–ø–µ—Ö! SID: ${result.session.sid}`, 'success');
      } else {
        showStatus(`‚ùå –¢–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${result.error}`, 'error');
        log(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    async function getVehicles() {
      if (!session || !workingToken) {
        showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Ä–∞–±–æ—á–∏–π —Ç–æ–∫–µ–Ω', 'error');
        return;
      }

      log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –°–ü–ò–°–ö–ê –¢–†–ê–ù–°–ü–û–†–¢–ê ===');
      showStatus('üöå –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...', 'loading');

      try {
        const response = await fetch(`${baseUrl}?svc=core/search_items&sid=${session.sid}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `params=${JSON.stringify({
            spec: {
              itemsType: 'avl_unit',
              propName: 'sys_name',
              propValueMask: '*',
              sortType: 'sys_name'
            },
            force: 1,
            flags: 0x1,
            from: 0,
            to: 0
          })}`
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        vehicles = data.items || [];
        log(`–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${vehicles.length}`, 'success');

        if (vehicles.length === 0) {
          showStatus('‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
          return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
        await updateVehiclePositions();
        showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`, 'success');

      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    async function updateVehiclePositions() {
      if (!vehicles.length || !session) return;

      try {
        log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');

        const vehicleIds = vehicles.map(v => v.id);
        const response = await fetch(`${baseUrl}?svc=core/update_data_flags&sid=${session.sid}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `params=${JSON.stringify({
            spec: vehicleIds.map(id => ({
              type: 'id',
              data: id,
              flags: 0x1 | 0x2
            }))
          })}`
        });

        const data = await response.json();
        displayVehicles();
        log('–ü–æ–∑–∏—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');

      } catch (error) {
        log(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π: ${error.message}`, 'error');
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    function displayVehicles() {
      const resultsDiv = document.getElementById('results');

      if (!vehicles.length) {
        resultsDiv.innerHTML = '';
        return;
      }

      let html = '<h3>üöå –í–∞—à —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</h3><div class="vehicle-list">';

      vehicles.forEach(vehicle => {
        const pos = vehicle.pos;
        const isOnline = pos && (Math.floor(Date.now() / 1000) - pos.t) < 600;
        const speed = pos?.s || 0;
        const status = !isOnline ? '–û—Ñ—Ñ–ª–∞–π–Ω' : speed > 5 ? '–í –¥–≤–∏–∂–µ–Ω–∏–∏' : '–û—Å—Ç–∞–Ω–æ–≤–∫–∞';

        html += `
          <div class="vehicle-item ${!isOnline ? 'vehicle-offline' : ''}">
            <strong>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</strong><br>
            <small>
              ID: ${vehicle.id} | –°—Ç–∞—Ç—É—Å: ${status} | –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á<br>
              ${pos ? `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.y?.toFixed(6)}, ${pos.x?.toFixed(6)}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏'}<br>
              ${pos ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(pos.t * 1000).toLocaleString()}` : ''}
            </small>
          </div>
        `;
      });

      html += '</div>';

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–±–æ—á–µ–º —Ç–æ–∫–µ–Ω–µ
      html += `
        <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745;">
          <strong>‚úÖ –†–∞–±–æ—á–∏–π —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω!</strong><br>
          <small>–¢–æ–∫–µ–Ω: ${workingToken.substring(0, 30)}...${workingToken.substring(workingToken.length - 10)}</small><br>
          <small>SID: ${session.sid}</small><br>
          <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}</small>
        </div>
      `;

      resultsDiv.innerHTML = html;
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('tokenGrid').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      document.getElementById('vehiclesBtn').disabled = true;
      hideProgress();
      workingToken = null;
      session = null;
      vehicles = [];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function () {
      log('üîë –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ Wialon –≥–æ—Ç–æ–≤–∞!');
      log(`–°–µ—Ä–≤–µ—Ä: ${baseUrl}`);
      log('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ –ø–æ–ª–µ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã"');
    };
  </script>
</body>

</html>