<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç Wialon —á–µ—Ä–µ–∑ JSONP - AKhamraev</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .success-block {
      background: #d4edda;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #28a745;
      color: #155724;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .vehicle-list {
      margin-top: 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .vehicle-item {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 4px solid #28a745;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 15px;
    }

    .vehicle-offline {
      border-left-color: #dc3545;
    }

    .vehicle-moving {
      border-left-color: #28a745;
    }

    .vehicle-stopped {
      border-left-color: #ffc107;
    }

    .vehicle-info h4 {
      margin: 0 0 5px 0;
      color: #495057;
    }

    .vehicle-details {
      font-size: 12px;
      color: #6c757d;
      line-height: 1.4;
    }

    .vehicle-status {
      text-align: center;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-moving {
      background: #d4edda;
      color: #155724;
    }

    .status-stopped {
      background: #fff3cd;
      color: #856404;
    }

    .status-offline {
      background: #f8d7da;
      color: #721c24;
    }

    .status-online {
      background: #cce5ff;
      color: #004085;
    }

    .session-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #dee2e6;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
    }

    .moving {
      color: #28a745;
    }

    .stopped {
      color: #ffc107;
    }

    .offline {
      color: #dc3545;
    }

    .total {
      color: #007bff;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üöÄ Wialon JSONP - –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!</h1>
    <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wialon —á–µ—Ä–µ–∑ JSONP —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ AKhamraev</p>

    <div class="success-block">
      <strong>‚úÖ JSONP —Ä–∞–±–æ—Ç–∞–µ—Ç!</strong><br>
      –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã.
      –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ CORS, –∫–æ—Ç–æ—Ä—É—é –º—ã —É—Å–ø–µ—à–Ω–æ –æ–±–æ—à–ª–∏ —á–µ—Ä–µ–∑ JSONP.
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="loginToWialon()">üîê –í–æ–π—Ç–∏ –≤ Wialon</button>
      <button class="btn" onclick="getVehiclesList()" id="vehiclesBtn" disabled>üöå –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
      <button class="btn" onclick="refreshPositions()" id="refreshBtn" disabled>üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏</button>
      <button class="btn" onclick="logout()" id="logoutBtn" disabled>üö™ –í—ã–π—Ç–∏</button>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ -->
    <div id="sessionInfo" style="display: none;"></div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="statsContainer" style="display: none;">
      <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</h3>
      <div class="stats-grid" id="stats"></div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="status"></div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ -->
    <div id="vehiclesList"></div>

    <!-- –õ–æ–≥–∏ -->
    <div id="log"></div>
  </div>

  <script>
    const credentials = {
      username: 'AKhamraev',
      password: 'xamrayev11'
    };

    const baseUrl = 'http://176.74.220.111/wialon/ajax.html';
    let session = null;
    let callbackCounter = 0;
    let vehicles = [];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // JSONP –∑–∞–ø—Ä–æ—Å
    function makeJsonpRequest(svc, params = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = `wialonCallback${++callbackCounter}`;
        const script = document.createElement('script');

        window[callbackName] = function (data) {
          document.head.removeChild(script);
          delete window[callbackName];

          if (data && data.error) {
            reject(new Error(data.error));
          } else {
            resolve(data);
          }
        };

        script.onerror = function () {
          document.head.removeChild(script);
          delete window[callbackName];
          reject(new Error('JSONP request failed'));
        };

        const url = new URL(baseUrl);
        url.searchParams.set('svc', svc);
        url.searchParams.set('params', JSON.stringify(params));
        url.searchParams.set('callback', callbackName);

        if (session) {
          url.searchParams.set('sid', session.sid);
        }

        log(`JSONP –∑–∞–ø—Ä–æ—Å: ${svc}`);
        script.src = url.toString();
        document.head.appendChild(script);

        setTimeout(() => {
          if (document.head.contains(script)) {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('JSONP timeout'));
          }
        }, 30000);
      });
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    async function loginToWialon() {
      log('=== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –í WIALON ===');
      showStatus('üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JSONP...', 'loading');

      try {
        const response = await makeJsonpRequest('core/login', {
          user: credentials.username,
          password: credentials.password
        });

        if (response.error) {
          throw new Error(response.error);
        }

        session = {
          sid: response.eid,
          userId: response.user?.id || 0,
          userName: response.user?.nm || 'Unknown'
        };

        log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!`, 'success');
        log(`SID: ${session.sid}`, 'success');
        log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`, 'success');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏
        document.getElementById('sessionInfo').style.display = 'block';
        document.getElementById('sessionInfo').innerHTML = `
          <div class="session-info">
            <strong>üîê –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è:</strong><br>
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName} (ID: ${session.userId})<br>
            SID: ${session.sid}<br>
            –í—Ä–µ–º—è –≤—Ö–æ–¥–∞: ${new Date().toLocaleString()}
          </div>
        `;

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('vehiclesBtn').disabled = false;
        document.getElementById('logoutBtn').disabled = false;

        showStatus(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${session.userName}!`, 'success');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å
        await setLocale();

      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª–∏
    async function setLocale() {
      try {
        const tzOffset = new Date().getTimezoneOffset() * -60;
        await makeJsonpRequest('render/set_locale', {
          tzOffset,
          language: 'ru'
        });
        log('–õ–æ–∫–∞–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'success');
      } catch (error) {
        log(`–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å: ${error.message}`);
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    async function getVehiclesList() {
      if (!session) {
        showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
        return;
      }

      log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –°–ü–ò–°–ö–ê –¢–†–ê–ù–°–ü–û–†–¢–ê ===');
      showStatus('üöå –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...', 'loading');

      try {
        const response = await makeJsonpRequest('core/search_items', {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: 0x1,
          from: 0,
          to: 0
        });

        vehicles = response.items || [];
        log(`–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${vehicles.length}`, 'success');

        if (vehicles.length === 0) {
          showStatus('‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
          return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
        await updateVehiclePositions();

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        document.getElementById('refreshBtn').disabled = false;

        showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`, 'success');

      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
    async function updateVehiclePositions() {
      if (!vehicles.length) return;

      try {
        log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');

        const vehicleIds = vehicles.map(v => v.id);
        await makeJsonpRequest('core/update_data_flags', {
          spec: vehicleIds.map(id => ({
            type: 'id',
            data: id,
            flags: 0x1 | 0x2
          }))
        });

        displayVehicles();
        updateStats();
        log('–ü–æ–∑–∏—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');

      } catch (error) {
        log(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π: ${error.message}`, 'error');
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    function displayVehicles() {
      const vehiclesDiv = document.getElementById('vehiclesList');

      if (!vehicles.length) {
        vehiclesDiv.innerHTML = '';
        return;
      }

      let html = '<h3>üöå –í–∞—à —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</h3><div class="vehicle-list">';

      vehicles.forEach(vehicle => {
        const pos = vehicle.pos;
        const isOnline = pos && (Math.floor(Date.now() / 1000) - pos.t) < 600;
        const speed = pos?.s || 0;
        const status = !isOnline ? 'offline' : speed > 5 ? 'moving' : 'stopped';
        const statusText = {
          moving: '–í –¥–≤–∏–∂–µ–Ω–∏–∏',
          stopped: '–û—Å—Ç–∞–Ω–æ–≤–∫–∞',
          offline: '–û—Ñ—Ñ–ª–∞–π–Ω',
          online: '–û–Ω–ª–∞–π–Ω'
        };

        html += `
          <div class="vehicle-item vehicle-${status}">
            <div class="vehicle-info">
              <h4>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</h4>
              <div class="vehicle-details">
                ID: ${vehicle.id}<br>
                –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á<br>
                ${pos ? `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.y?.toFixed(6)}, ${pos.x?.toFixed(6)}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏'}<br>
                ${pos ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(pos.t * 1000).toLocaleString()}` : ''}
              </div>
            </div>
            <div class="vehicle-status status-${status}">
              ${statusText[status]}
            </div>
          </div>
        `;
      });

      html += '</div>';
      vehiclesDiv.innerHTML = html;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStats() {
      const statsContainer = document.getElementById('statsContainer');
      const statsDiv = document.getElementById('stats');

      if (!vehicles.length) {
        statsContainer.style.display = 'none';
        return;
      }

      const stats = {
        total: vehicles.length,
        moving: 0,
        stopped: 0,
        offline: 0
      };

      vehicles.forEach(vehicle => {
        const pos = vehicle.pos;
        const isOnline = pos && (Math.floor(Date.now() / 1000) - pos.t) < 600;
        const speed = pos?.s || 0;

        if (!isOnline) {
          stats.offline++;
        } else if (speed > 5) {
          stats.moving++;
        } else {
          stats.stopped++;
        }
      });

      statsDiv.innerHTML = `
        <div class="stat-card">
          <div class="stat-value total">${stats.total}</div>
          <div class="stat-label">–í—Å–µ–≥–æ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value moving">${stats.moving}</div>
          <div class="stat-label">–í –¥–≤–∏–∂–µ–Ω–∏–∏</div>
        </div>
        <div class="stat-card">
          <div class="stat-value stopped">${stats.stopped}</div>
          <div class="stat-label">–ù–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value offline">${stats.offline}</div>
          <div class="stat-label">–û—Ñ—Ñ–ª–∞–π–Ω</div>
        </div>
      `;

      statsContainer.style.display = 'block';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
    async function refreshPositions() {
      showStatus('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π...', 'loading');
      await updateVehiclePositions();
      showStatus('‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
    }

    // –í—ã—Ö–æ–¥
    async function logout() {
      if (!session) return;

      try {
        await makeJsonpRequest('core/logout');
        session = null;
        vehicles = [];

        // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('vehiclesBtn').disabled = true;
        document.getElementById('refreshBtn').disabled = true;
        document.getElementById('logoutBtn').disabled = true;

        // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('sessionInfo').style.display = 'none';
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('vehiclesList').innerHTML = '';

        showStatus('‚úÖ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
        log('–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');

      } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${error.message}`, 'error');
      }
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
      if (session && vehicles.length > 0) {
        updateVehiclePositions();
      }
    }, 30000);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function () {
      log('üöÄ Wialon JSONP —Å–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
      log(`–°–µ—Ä–≤–µ—Ä: ${baseUrl}`);
      log(`–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${credentials.username}`);
      log('JSONP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –º–æ–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è!');
    };
  </script>
</body>

</html>