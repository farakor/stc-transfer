<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã - gps.ent-en.com</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .warning-block {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .method-card {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 3px solid #007bff;
    }

    .method-card.success {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .method-card.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .method-card.loading {
      border-left-color: #ffc107;
      background: #fff3cd;
    }

    .code-block {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      margin: 10px 0;
      border: 1px solid #dee2e6;
    }

    .vehicle-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .vehicle-item {
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #28a745;
    }

    .vehicle-offline {
      border-left-color: #dc3545;
    }

    .vehicle-moving {
      border-left-color: #28a745;
    }

    .vehicle-stopped {
      border-left-color: #ffc107;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ gps.ent-en.com</h1>
    
    <div class="warning-block">
      <strong>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ CORS:</strong> –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –±—Ä–∞—É–∑–µ—Ä–æ–º (Failed to fetch).<br>
      <strong>‚úÖ –†–µ—à–µ–Ω–∏–µ:</strong> –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–±—Ö–æ–¥–∞ CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
    </div>

    <div class="info-block">
      <strong>üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã:</strong><br>
      1. <strong>JSONP</strong> - –æ–±—Ö–æ–¥ CORS —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ script —Ç–µ–≥–∏<br>
      2. <strong>–ü—É–±–ª–∏—á–Ω—ã–π CORS –ø—Ä–æ–∫—Å–∏</strong> - —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä<br>
      3. <strong>–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏</strong> - —á–µ—Ä–µ–∑ –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–∫—Å–∏<br>
      4. <strong>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä—Ç—ã</strong> - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤<br>
      <strong>üîë –¢–æ–∫–µ–Ω:</strong> <code>85991e5f06896e98fe3c0bd49d2fe6d8EC2B0F5F2A7A963F0EC0B869EB87FF8188C6EE8D</code>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="testAllMethods()">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã</button>
      <button class="btn" onclick="testJsonp()">üìú –¢–µ—Å—Ç JSONP</button>
      <button class="btn" onclick="testCorsProxy()">üåê –¢–µ—Å—Ç CORS –ø—Ä–æ–∫—Å–∏</button>
      <button class="btn" onclick="getVehicles()" id="vehiclesBtn" disabled>üöå –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <!-- –ú–µ—Ç–æ–¥—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div id="methods">
      <div class="method-card" id="method-jsonp">
        <strong>–ú–µ—Ç–æ–¥ 1: JSONP (JSON with Padding)</strong>
        <div class="code-block">–û–±—Ö–æ–¥ CORS —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ script —Ç–µ–≥–∏</div>
        <div id="result-jsonp"></div>
      </div>
      
      <div class="method-card" id="method-cors-proxy">
        <strong>–ú–µ—Ç–æ–¥ 2: –ü—É–±–ª–∏—á–Ω—ã–π CORS –ø—Ä–æ–∫—Å–∏</strong>
        <div class="code-block">https://cors-anywhere.herokuapp.com/https://gps.ent-en.com/wialon/ajax.html</div>
        <div id="result-cors-proxy"></div>
      </div>
      
      <div class="method-card" id="method-allorigins">
        <strong>–ú–µ—Ç–æ–¥ 3: AllOrigins –ø—Ä–æ–∫—Å–∏</strong>
        <div class="code-block">https://api.allorigins.win/raw?url=https://gps.ent-en.com/wialon/ajax.html</div>
        <div id="result-allorigins"></div>
      </div>
      
      <div class="method-card" id="method-ports">
        <strong>–ú–µ—Ç–æ–¥ 4: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä—Ç—ã</strong>
        <div class="code-block">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ 80, 443, 8080, 8443</div>
        <div id="result-ports"></div>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="status"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="results"></div>

    <!-- –õ–æ–≥–∏ -->
    <div id="log"></div>
  </div>

  <script>
    const serverHost = 'gps.ent-en.com';
    const token = '85991e5f06896e98fe3c0bd49d2fe6d8EC2B0F5F2A7A963F0EC0B869EB87FF8188C6EE8D';
    let session = null;
    let vehicles = [];
    let workingMethod = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function updateMethodResult(methodId, status, message) {
      const methodDiv = document.getElementById(`method-${methodId}`);
      const resultDiv = document.getElementById(`result-${methodId}`);
      
      methodDiv.className = `method-card ${status}`;
      resultDiv.innerHTML = `<small>${message}</small>`;
    }

    // JSONP –º–µ—Ç–æ–¥
    function testJsonp() {
      return new Promise((resolve) => {
        log('=== –¢–ï–°–¢ JSONP –ú–ï–¢–û–î–ê ===');
        updateMethodResult('jsonp', 'loading', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JSONP...');

        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è callback —Ñ—É–Ω–∫—Ü–∏–∏
        const callbackName = 'wialonCallback_' + Date.now();
        
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é callback —Ñ—É–Ω–∫—Ü–∏—é
        window[callbackName] = function(data) {
          try {
            if (data.error) {
              throw new Error(`Wialon Error: ${data.error}`);
            }

            session = {
              sid: data.eid,
              userId: data.user?.id || 0,
              userName: data.user?.nm || 'Unknown',
              method: 'jsonp',
              apiUrl: `https://${serverHost}/wialon/ajax.html`
            };

            workingMethod = 'jsonp';
            updateMethodResult('jsonp', 'success', `‚úÖ JSONP —Ä–∞–±–æ—Ç–∞–µ—Ç! SID: ${session.sid}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`);
            log(`‚úÖ JSONP —É—Å–ø–µ—à–Ω–æ! SID: ${session.sid}`, 'success');
            document.getElementById('vehiclesBtn').disabled = false;
            resolve(true);
          } catch (error) {
            updateMethodResult('jsonp', 'error', `‚ùå ${error.message}`);
            log(`‚ùå JSONP –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            resolve(false);
          } finally {
            // –û—á–∏—â–∞–µ–º callback —Ñ—É–Ω–∫—Ü–∏—é
            delete window[callbackName];
            // –£–¥–∞–ª—è–µ–º script —Ç–µ–≥
            const script = document.getElementById('jsonp-script');
            if (script) {
              script.remove();
            }
          }
        };

        // –°–æ–∑–¥–∞–µ–º script —Ç–µ–≥ –¥–ª—è JSONP –∑–∞–ø—Ä–æ—Å–∞
        const script = document.createElement('script');
        script.id = 'jsonp-script';
        script.src = `https://${serverHost}/wialon/ajax.html?svc=token/login&params=${encodeURIComponent(JSON.stringify({ token: token }))}&callback=${callbackName}`;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        script.onerror = function() {
          updateMethodResult('jsonp', 'error', '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSONP —Å–∫—Ä–∏–ø—Ç–∞');
          log('‚ùå JSONP: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞', 'error');
          delete window[callbackName];
          resolve(false);
        };

        // –¢–∞–π–º–∞—É—Ç –¥–ª—è JSONP
        setTimeout(() => {
          if (window[callbackName]) {
            updateMethodResult('jsonp', 'error', '‚ùå JSONP —Ç–∞–π–º–∞—É—Ç');
            log('‚ùå JSONP: –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞', 'error');
            delete window[callbackName];
            if (script) script.remove();
            resolve(false);
          }
        }, 10000);

        document.head.appendChild(script);
      });
    }

    // CORS –ø—Ä–æ–∫—Å–∏ –º–µ—Ç–æ–¥
    async function testCorsProxy() {
      log('=== –¢–ï–°–¢ CORS –ü–†–û–ö–°–ò ===');
      updateMethodResult('cors-proxy', 'loading', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CORS –ø—Ä–æ–∫—Å–∏...');

      const proxyUrl = `https://cors-anywhere.herokuapp.com/https://${serverHost}/wialon/ajax.html`;
      
      try {
        const response = await fetch(`${proxyUrl}?svc=token/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: `params=${JSON.stringify({ token: token })}`
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(`Wialon Error: ${data.error}`);
        }

        session = {
          sid: data.eid,
          userId: data.user?.id || 0,
          userName: data.user?.nm || 'Unknown',
          method: 'cors-proxy',
          apiUrl: proxyUrl
        };

        workingMethod = 'cors-proxy';
        updateMethodResult('cors-proxy', 'success', `‚úÖ CORS –ø—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! SID: ${session.sid}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`);
        log(`‚úÖ CORS –ø—Ä–æ–∫—Å–∏ —É—Å–ø–µ—à–Ω–æ! SID: ${session.sid}`, 'success');
        document.getElementById('vehiclesBtn').disabled = false;
        return true;

      } catch (error) {
        updateMethodResult('cors-proxy', 'error', `‚ùå ${error.message}`);
        log(`‚ùå CORS –ø—Ä–æ–∫—Å–∏ –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
        return false;
      }
    }

    // AllOrigins –ø—Ä–æ–∫—Å–∏ –º–µ—Ç–æ–¥
    async function testAllOrigins() {
      log('=== –¢–ï–°–¢ ALLORIGINS –ü–†–û–ö–°–ò ===');
      updateMethodResult('allorigins', 'loading', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AllOrigins...');

      const targetUrl = `https://${serverHost}/wialon/ajax.html?svc=token/login`;
      const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
      
      try {
        const response = await fetch(proxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `params=${JSON.stringify({ token: token })}`
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(`Wialon Error: ${data.error}`);
        }

        session = {
          sid: data.eid,
          userId: data.user?.id || 0,
          userName: data.user?.nm || 'Unknown',
          method: 'allorigins',
          apiUrl: `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://${serverHost}/wialon/ajax.html`)}`
        };

        workingMethod = 'allorigins';
        updateMethodResult('allorigins', 'success', `‚úÖ AllOrigins —Ä–∞–±–æ—Ç–∞–µ—Ç! SID: ${session.sid}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`);
        log(`‚úÖ AllOrigins —É—Å–ø–µ—à–Ω–æ! SID: ${session.sid}`, 'success');
        document.getElementById('vehiclesBtn').disabled = false;
        return true;

      } catch (error) {
        updateMethodResult('allorigins', 'error', `‚ùå ${error.message}`);
        log(`‚ùå AllOrigins –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
        return false;
      }
    }

    // –¢–µ—Å—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤
    async function testAlternativePorts() {
      log('=== –¢–ï–°–¢ –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–• –ü–û–†–¢–û–í ===');
      updateMethodResult('ports', 'loading', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤...');

      const ports = [80, 443, 8080, 8443, 9090];
      
      for (const port of ports) {
        try {
          log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–∞ ${port}...`);
          const url = `https://${serverHost}:${port}/wialon/ajax.html`;
          
          const response = await fetch(`${url}?svc=token/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `params=${JSON.stringify({ token: token })}`
          });

          if (response.ok) {
            const data = await response.json();
            if (!data.error) {
              session = {
                sid: data.eid,
                userId: data.user?.id || 0,
                userName: data.user?.nm || 'Unknown',
                method: 'port',
                apiUrl: url
              };

              workingMethod = 'port';
              updateMethodResult('ports', 'success', `‚úÖ –ü–æ—Ä—Ç ${port} —Ä–∞–±–æ—Ç–∞–µ—Ç! SID: ${session.sid}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`);
              log(`‚úÖ –ü–æ—Ä—Ç ${port} —É—Å–ø–µ—à–Ω–æ! SID: ${session.sid}`, 'success');
              document.getElementById('vehiclesBtn').disabled = false;
              return true;
            }
          }
        } catch (error) {
          log(`‚ùå –ü–æ—Ä—Ç ${port}: ${error.message}`, 'error');
        }
      }

      updateMethodResult('ports', 'error', '‚ùå –ù–∏ –æ–¥–∏–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
      return false;
    }

    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
    async function testAllMethods() {
      log('=== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –í–°–ï–• –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–• –ú–ï–¢–û–î–û–í ===');
      showStatus('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤...', 'loading');

      // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
      session = null;
      vehicles = [];
      workingMethod = null;
      document.getElementById('vehiclesBtn').disabled = true;

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º JSONP
      const jsonpSuccess = await testJsonp();
      if (jsonpSuccess) {
        showStatus(`‚úÖ JSONP –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`, 'success');
        return;
      }

      await new Promise(resolve => setTimeout(resolve, 1000));

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º CORS –ø—Ä–æ–∫—Å–∏
      const corsSuccess = await testCorsProxy();
      if (corsSuccess) {
        showStatus(`‚úÖ CORS –ø—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`, 'success');
        return;
      }

      await new Promise(resolve => setTimeout(resolve, 1000));

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º AllOrigins
      const allOriginsSuccess = await testAllOrigins();
      if (allOriginsSuccess) {
        showStatus(`‚úÖ AllOrigins –ø—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`, 'success');
        return;
      }

      await new Promise(resolve => setTimeout(resolve, 1000));

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä—Ç—ã
      const portsSuccess = await testAlternativePorts();
      if (portsSuccess) {
        showStatus(`‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`, 'success');
        return;
      }

      showStatus('‚ùå –ù–∏ –æ–¥–∏–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error');
      log('=== –í–°–ï –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –ú–ï–¢–û–î–´ –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–´ - –ù–ò –û–î–ò–ù –ù–ï –†–ê–ë–û–¢–ê–ï–¢ ===', 'error');
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ JSONP
    function getVehiclesJsonp() {
      return new Promise((resolve) => {
        log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –¢–†–ê–ù–°–ü–û–†–¢–ê –ß–ï–†–ï–ó JSONP ===');
        
        const callbackName = 'wialonVehiclesCallback_' + Date.now();
        
        window[callbackName] = function(data) {
          try {
            if (data.error) {
              throw new Error(`Wialon Error: ${data.error}`);
            }

            vehicles = data.items || [];
            log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ —á–µ—Ä–µ–∑ JSONP: ${vehicles.length}`, 'success');
            
            if (vehicles.length > 0) {
              // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ JSONP
              updateVehiclePositionsJsonp().then(() => {
                displayVehicles();
                showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ —á–µ—Ä–µ–∑ JSONP`, 'success');
                resolve(true);
              });
            } else {
              showStatus('‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
              resolve(false);
            }
          } catch (error) {
            log(`‚ùå JSONP —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            showStatus(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
            resolve(false);
          } finally {
            delete window[callbackName];
            const script = document.getElementById('jsonp-vehicles-script');
            if (script) script.remove();
          }
        };

        const searchParams = {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: 0x1,
          from: 0,
          to: 0
        };

        const script = document.createElement('script');
        script.id = 'jsonp-vehicles-script';
        script.src = `https://${serverHost}/wialon/ajax.html?svc=core/search_items&sid=${session.sid}&params=${encodeURIComponent(JSON.stringify(searchParams))}&callback=${callbackName}`;
        
        script.onerror = function() {
          log('‚ùå JSONP: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞', 'error');
          showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞', 'error');
          delete window[callbackName];
          resolve(false);
        };

        setTimeout(() => {
          if (window[callbackName]) {
            log('‚ùå JSONP: –¢–∞–π–º–∞—É—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞', 'error');
            showStatus('‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞', 'error');
            delete window[callbackName];
            if (script) script.remove();
            resolve(false);
          }
        }, 15000);

        document.head.appendChild(script);
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ JSONP
    function updateVehiclePositionsJsonp() {
      return new Promise((resolve) => {
        if (!vehicles.length) {
          resolve();
          return;
        }

        log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ JSONP...');
        
        const callbackName = 'wialonPositionsCallback_' + Date.now();
        
        window[callbackName] = function(data) {
          try {
            if (data.error) {
              log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π: ${data.error}`, 'error');
            } else {
              log('‚úÖ –ü–æ–∑–∏—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JSONP', 'success');
            }
          } catch (error) {
            log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∑–∏—Ü–∏–π: ${error.message}`, 'error');
          } finally {
            delete window[callbackName];
            const script = document.getElementById('jsonp-positions-script');
            if (script) script.remove();
            resolve();
          }
        };

        const vehicleIds = vehicles.map(v => v.id);
        const updateParams = {
          spec: vehicleIds.map(id => ({
            type: 'id',
            data: id,
            flags: 0x1 | 0x2
          }))
        };

        const script = document.createElement('script');
        script.id = 'jsonp-positions-script';
        script.src = `https://${serverHost}/wialon/ajax.html?svc=core/update_data_flags&sid=${session.sid}&params=${encodeURIComponent(JSON.stringify(updateParams))}&callback=${callbackName}`;
        
        script.onerror = function() {
          log('‚ùå JSONP: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π', 'error');
          delete window[callbackName];
          resolve();
        };

        setTimeout(() => {
          if (window[callbackName]) {
            log('‚ùå JSONP: –¢–∞–π–º–∞—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π', 'error');
            delete window[callbackName];
            if (script) script.remove();
            resolve();
          }
        }, 10000);

        document.head.appendChild(script);
      });
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    async function getVehicles() {
      if (!session) {
        showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Ä–∞–±–æ—á–∏–π –º–µ—Ç–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
        return;
      }

      log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –°–ü–ò–°–ö–ê –¢–†–ê–ù–°–ü–û–†–¢–ê ===');
      showStatus('üöå –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...', 'loading');

      try {
        if (workingMethod === 'jsonp') {
          // –î–ª—è JSONP –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
          await getVehiclesJsonp();
        } else {
          // –î–ª—è –ø—Ä–æ–∫—Å–∏ –º–µ—Ç–æ–¥–æ–≤
          const response = await fetch(`${session.apiUrl}?svc=core/search_items&sid=${session.sid}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `params=${JSON.stringify({
              spec: {
                itemsType: 'avl_unit',
                propName: 'sys_name',
                propValueMask: '*',
                sortType: 'sys_name'
              },
              force: 1,
              flags: 0x1,
              from: 0,
              to: 0
            })}`
          });

          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }

          vehicles = data.items || [];
          log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${vehicles.length}`, 'success');

          if (vehicles.length === 0) {
            showStatus('‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
            return;
          }

          displayVehicles();
          showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ —á–µ—Ä–µ–∑ ${workingMethod}`, 'success');
        }

      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    function displayVehicles() {
      const resultsDiv = document.getElementById('results');
      
      if (!vehicles.length) {
        resultsDiv.innerHTML = '';
        return;
      }

      let html = '<h3>üöå –í–∞—à —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</h3><div class="vehicle-list">';
      const now = Math.floor(Date.now() / 1000);

      let online = 0, moving = 0, stopped = 0;

      vehicles.forEach(vehicle => {
        const pos = vehicle.pos;
        const isOnline = pos && (now - pos.t) < 600;
        const speed = pos?.s || 0;
        let status = '–û—Ñ—Ñ–ª–∞–π–Ω';
        let statusClass = 'vehicle-offline';
        
        if (isOnline) {
          online++;
          if (speed > 5) {
            status = '–í –¥–≤–∏–∂–µ–Ω–∏–∏';
            statusClass = 'vehicle-moving';
            moving++;
          } else {
            status = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞';
            statusClass = 'vehicle-stopped';
            stopped++;
          }
        }

        html += `
          <div class="vehicle-item ${statusClass}">
            <strong>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</strong><br>
            <small>
              ID: ${vehicle.id} | –°—Ç–∞—Ç—É—Å: ${status} | –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á<br>
              ${pos ? `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.y?.toFixed(6)}, ${pos.x?.toFixed(6)}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏'}<br>
              ${pos ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(pos.t * 1000).toLocaleString()}` : ''}
            </small>
          </div>
        `;
      });

      html += '</div>';
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      html += `
        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
          <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
          <small>
            –í—Å–µ–≥–æ: ${vehicles.length} | 
            –û–Ω–ª–∞–π–Ω: ${online} | 
            –í –¥–≤–∏–∂–µ–Ω–∏–∏: ${moving} | 
            –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ${stopped} | 
            –û—Ñ—Ñ–ª–∞–π–Ω: ${vehicles.length - online}
          </small>
        </div>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
      html += `
        <div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 6px;">
          <strong>‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ gps.ent-en.com —É—Å–ø–µ—à–Ω–æ!</strong><br>
          <small>–ú–µ—Ç–æ–¥: ${workingMethod}</small><br>
          <small>API: ${session.apiUrl}</small><br>
          <small>SID: ${session.sid}</small><br>
          <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}</small>
        </div>
      `;
      
      resultsDiv.innerHTML = html;
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      document.getElementById('vehiclesBtn').disabled = true;
      
      // –°–±—Ä–æ—Å –º–µ—Ç–æ–¥–æ–≤
      ['jsonp', 'cors-proxy', 'allorigins', 'ports'].forEach(methodId => {
        document.getElementById(`method-${methodId}`).className = 'method-card';
        document.getElementById(`result-${methodId}`).innerHTML = '';
      });
      
      session = null;
      vehicles = [];
      workingMethod = null;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function() {
      log('üîÑ –°–∏—Å—Ç–µ–º–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è gps.ent-en.com –≥–æ—Ç–æ–≤–∞!');
      log(`–°–µ—Ä–≤–µ—Ä: ${serverHost}`);
      log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 30)}...`);
      log('–ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã" –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π');
    };
  </script>
</body>

</html>
