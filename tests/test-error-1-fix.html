<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ 1 Wialon</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .warning-block {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .comparison-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }

    .comparison-item.old {
      border-left: 3px solid #dc3545;
    }

    .comparison-item.new {
      border-left: 3px solid #28a745;
    }

    .code {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ 1 Wialon</h1>
    
    <div class="info-block">
      <strong>üéØ –ü—Ä–æ–±–ª–µ–º–∞:</strong> –û—à–∏–±–∫–∞ 1 = "Invalid input" - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã<br>
      <strong>üîß –†–µ—à–µ–Ω–∏–µ:</strong> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö —á–∏—Å–µ–ª –≤–º–µ—Å—Ç–æ hex –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö flags<br>
      <strong>üîë –¢–æ–∫–µ–Ω:</strong> 85991e5f06896e98fe3c0bd49d2fe6d825770468546E156C3088DF44EB44163B2A478841<br>
      <strong>üåê –°–µ—Ä–≤–µ—Ä:</strong> gps.ent-en.com
    </div>

    <div class="warning-block">
      <strong>‚ö†Ô∏è –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong><br>
      ‚Ä¢ <code>flags: 0x1</code> ‚Üí <code>flags: 1</code><br>
      ‚Ä¢ <code>flags: 0x1 | 0x2</code> ‚Üí <code>flags: 3</code><br>
      –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–µ—Ä—ã Wialon –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç hex —Ñ–æ—Ä–º–∞—Ç –≤ JSONP –∑–∞–ø—Ä–æ—Å–∞—Ö
    </div>

    <div class="comparison">
      <div class="comparison-item old">
        <h4>‚ùå –°—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤—ã–∑—ã–≤–∞–ª–∏ –æ—à–∏–±–∫—É 1)</h4>
        <div class="code">flags: 0x1 // hex —Ñ–æ—Ä–º–∞—Ç</div>
        <div class="code">flags: 0x1 | 0x2 // –±–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
      </div>
      <div class="comparison-item new">
        <h4>‚úÖ –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)</h4>
        <div class="code">flags: 1 // –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç</div>
        <div class="code">flags: 3 // 1 + 2 = 3</div>
      </div>
    </div>

    <div style="text-align: center; margin: 20px 0;">
      <button class="btn success" onclick="testNewParameters()">üöÄ –¢–µ—Å—Ç —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏</button>
      <button class="btn" onclick="testOldParameters()">‚ùå –¢–µ—Å—Ç —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div id="status"></div>
    <div id="log"></div>
  </div>

  <script>
    const serverHost = 'gps.ent-en.com';
    const token = '85991e5f06896e98fe3c0bd49d2fe6d825770468546E156C3088DF44EB44163B2A478841';
    let session = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // JSONP –∑–∞–ø—Ä–æ—Å
    function makeJsonpRequest(service, params, sid) {
      return new Promise((resolve, reject) => {
        const callbackName = 'wialonCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        window[callbackName] = function(data) {
          try {
            if (data.error) {
              reject(new Error(`Wialon API Error: ${data.error}`));
            } else {
              resolve(data);
            }
          } catch (error) {
            reject(error);
          } finally {
            delete window[callbackName];
            const script = document.getElementById(`jsonp-${callbackName}`);
            if (script) script.remove();
          }
        };

        let url = `https://${serverHost}/wialon/ajax.html?svc=${service}`;
        if (sid) url += `&sid=${sid}`;
        url += `&params=${encodeURIComponent(JSON.stringify(params))}`;
        url += `&callback=${callbackName}`;

        const script = document.createElement('script');
        script.id = `jsonp-${callbackName}`;
        script.src = url;
        
        script.onerror = () => {
          delete window[callbackName];
          reject(new Error('JSONP request failed'));
        };

        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script) script.remove();
            reject(new Error('JSONP timeout'));
          }
        }, 10000);

        document.head.appendChild(script);
      });
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    async function login() {
      log('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
      try {
        const response = await makeJsonpRequest('token/login', { token: token });
        session = {
          sid: response.eid,
          userName: response.user?.nm || 'Unknown'
        };
        log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! SID: ${session.sid}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`, 'success');
        return session;
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
        throw error;
      }
    }

    // –¢–µ—Å—Ç —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏)
    async function testNewParameters() {
      log('=== –¢–ï–°–¢ –° –ù–û–í–´–ú–ò –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú–ò) ===');
      showStatus('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...', 'loading');

      try {
        await login();
        
        log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ core/search_items —Å flags: 1...');
        const response = await makeJsonpRequest('core/search_items', {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: 1, // –î–µ—Å—è—Ç–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
          from: 0,
          to: 0
        }, session.sid);

        const vehicles = response.items || [];
        log(`‚úÖ –£—Å–ø–µ—Ö! –ü–æ–ª—É—á–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${vehicles.length}`, 'success');

        if (vehicles.length > 0) {
          log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ core/update_data_flags —Å flags: 3...');
          try {
            await makeJsonpRequest('core/update_data_flags', {
              spec: vehicles.slice(0, 3).map(v => ({
                type: 'id',
                data: v.id,
                flags: 3 // 1 + 2 = 3 (–¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
              }))
            }, session.sid);
            
            log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ!', 'success');
          } catch (updateError) {
            if (updateError.message.includes('Wialon API Error: 4')) {
              log('üîÑ –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...', 'error');
              await login();
              
              // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–µ–π
              await makeJsonpRequest('core/update_data_flags', {
                spec: vehicles.slice(0, 3).map(v => ({
                  type: 'id',
                  data: v.id,
                  flags: 3
                }))
              }, session.sid);
              
              log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!', 'success');
            } else {
              throw updateError;
            }
          }
        }

        showStatus(`‚úÖ –¢–µ—Å—Ç —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —É—Å–ø–µ—à–µ–Ω! –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${vehicles.length}`, 'success');
        log(`üéâ –ù–û–í–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –†–ê–ë–û–¢–ê–Æ–¢! –û—à–∏–±–∫–∞ 1 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!`, 'success');
        
      } catch (error) {
        showStatus(`‚ùå –¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`, 'error');
        log(`üí• –û–®–ò–ë–ö–ê –° –ù–û–í–´–ú–ò –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò: ${error.message}`, 'error');
      }
    }

    // –¢–µ—Å—Ç —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
    async function testOldParameters() {
      log('=== –¢–ï–°–¢ –°–û –°–¢–ê–†–´–ú–ò –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò (–î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø) ===');
      showStatus('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...', 'loading');

      try {
        await login();
        
        log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ core/search_items —Å flags: 0x1 (hex)...');
        const response = await makeJsonpRequest('core/search_items', {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: 0x1, // Hex —Ñ–æ—Ä–º–∞—Ç (–º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É 1)
          from: 0,
          to: 0
        }, session.sid);

        const vehicles = response.items || [];
        log(`‚úÖ –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ! –°—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç: ${vehicles.length}`, 'success');
        showStatus(`‚úÖ –°—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç! –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${vehicles.length}`, 'success');
        
      } catch (error) {
        if (error.message.includes('Wialon API Error: 1')) {
          showStatus(`‚úÖ –û–∂–∏–¥–∞–µ–º–æ: —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫—É 1`, 'error');
          log(`‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –°—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫—É 1 (${error.message})`, 'error');
          log(`üîß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è!`, 'success');
        } else {
          showStatus(`‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
          log(`‚ùå –ù–ï–û–ñ–ò–î–ê–ù–ù–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
        }
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      session = null;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function() {
      log('üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ 1 –≥–æ—Ç–æ–≤!');
      log(`–°–µ—Ä–≤–µ—Ä: ${serverHost}`);
      log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 30)}...`);
      log('–ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
    };
  </script>
</body>

</html>
