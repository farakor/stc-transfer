<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç —Ñ–ª–∞–≥–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .test-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .test-result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
    }

    .test-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .test-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .test-result.loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .flag-info {
      background: #fff3cd;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 12px;
      border: 1px solid #ffeaa7;
    }

    .vehicle-sample {
      background: white;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 3px solid #007bff;
      font-size: 11px;
    }

    .vehicle-sample.has-position {
      border-left-color: #28a745;
    }

    .vehicle-sample.no-position {
      border-left-color: #dc3545;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üéØ –¢–µ—Å—Ç —Ñ–ª–∞–≥–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π</h1>
    
    <div class="info-block">
      <strong>üéØ –¶–µ–ª—å:</strong> –ù–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è GPS –ø–æ–∑–∏—Ü–∏–π –±–µ–∑ update_data_flags<br>
      <strong>üîç –ü—Ä–æ–±–ª–µ–º–∞:</strong> –í—Å–µ 48 –µ–¥–∏–Ω–∏—Ü —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏<br>
      <strong>üí° –†–µ—à–µ–Ω–∏–µ:</strong> –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–ª–∞–≥–∏ –≤ core/search_items
    </div>

    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="testAllFlags()">üöÄ –¢–µ—Å—Ç –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div id="status"></div>

    <!-- –°–µ—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤ -->
    <div class="test-grid" id="testGrid"></div>

    <div id="log"></div>
  </div>

  <script>
    const serverHost = 'gps.ent-en.com';
    const token = '85991e5f06896e98fe3c0bd49d2fe6d825770468546E156C3088DF44EB44163B2A478841';
    let session = null;

    // –†–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const flagTests = [
      { name: '–ë–∞–∑–æ–≤—ã–π (1)', flag: 1, description: '–¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' },
      { name: '–° –ø–æ–∑–∏—Ü–∏—è–º–∏ (1025)', flag: 1025, description: '0x1 + 0x400 - –±–∞–∑–æ–≤—ã–µ + –ø–æ–∑–∏—Ü–∏–∏' },
      { name: '–í—Å–µ –¥–∞–Ω–Ω—ã–µ (1023)', flag: 1023, description: '0x3FF - –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' },
      { name: '–ü–æ–∑–∏—Ü–∏–∏ + —Å–æ–æ–±—â–µ–Ω–∏—è (1027)', flag: 1027, description: '0x1 + 0x2 + 0x400' },
      { name: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (2047)', flag: 2047, description: '0x7FF - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä' },
      { name: '–¢–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–∏ (1024)', flag: 1024, description: '0x400 - —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–∏' }
    ];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // JSONP –∑–∞–ø—Ä–æ—Å
    function makeJsonpRequest(service, params, sid) {
      return new Promise((resolve, reject) => {
        const callbackName = 'wialonCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        window[callbackName] = function(data) {
          try {
            if (data.error) {
              reject(new Error(`Wialon API Error: ${data.error}`));
            } else {
              resolve(data);
            }
          } catch (error) {
            reject(error);
          } finally {
            delete window[callbackName];
            const script = document.getElementById(`jsonp-${callbackName}`);
            if (script) script.remove();
          }
        };

        let url = `https://${serverHost}/wialon/ajax.html?svc=${service}`;
        if (sid) url += `&sid=${sid}`;
        url += `&params=${encodeURIComponent(JSON.stringify(params))}`;
        url += `&callback=${callbackName}`;

        const script = document.createElement('script');
        script.id = `jsonp-${callbackName}`;
        script.src = url;
        
        script.onerror = () => {
          delete window[callbackName];
          reject(new Error('JSONP request failed'));
        };

        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script) script.remove();
            reject(new Error('JSONP timeout'));
          }
        }, 15000);

        document.head.appendChild(script);
      });
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    async function login() {
      if (session) return session;
      
      log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...');
      try {
        const response = await makeJsonpRequest('token/login', { token: token });
        session = {
          sid: response.eid,
          userName: response.user?.nm || 'Unknown'
        };
        log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! SID: ${session.sid}`, 'success');
        return session;
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
        throw error;
      }
    }

    // –¢–µ—Å—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–ª–∞–≥–∞
    async function testFlag(flagInfo) {
      const cardId = `test-${flagInfo.flag}`;
      const card = document.getElementById(cardId);
      const resultDiv = card.querySelector('.test-result');
      
      resultDiv.innerHTML = '<div class="test-result loading">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';
      
      try {
        await login();
        
        log(`üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–ª–∞–≥–∞ ${flagInfo.flag} (${flagInfo.name})`);
        
        const response = await makeJsonpRequest('core/search_items', {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: flagInfo.flag,
          from: 0,
          to: 5 // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã
        }, session.sid);

        const vehicles = response.items || [];
        let withPosition = 0;
        let withoutPosition = 0;
        
        vehicles.forEach(vehicle => {
          if (vehicle.pos && vehicle.pos.y !== 0 && vehicle.pos.x !== 0) {
            withPosition++;
          } else {
            withoutPosition++;
          }
        });

        const success = withPosition > 0;
        const resultClass = success ? 'success' : 'error';
        const resultIcon = success ? '‚úÖ' : '‚ùå';
        
        let resultHtml = `
          <div class="test-result ${resultClass}">
            ${resultIcon} <strong>${flagInfo.name}</strong><br>
            –í—Å–µ–≥–æ: ${vehicles.length} | –° –ø–æ–∑–∏—Ü–∏–µ–π: ${withPosition} | –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏: ${withoutPosition}
          </div>
        `;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã
        if (vehicles.length > 0) {
          resultHtml += '<div style="margin-top: 10px;">';
          vehicles.slice(0, 2).forEach(vehicle => {
            const hasPos = vehicle.pos && vehicle.pos.y !== 0 && vehicle.pos.x !== 0;
            const posClass = hasPos ? 'has-position' : 'no-position';
            const posText = hasPos ? 
              `üìç ${vehicle.pos.y.toFixed(6)}, ${vehicle.pos.x.toFixed(6)}` : 
              '‚ùå –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–∏';
            
            resultHtml += `
              <div class="vehicle-sample ${posClass}">
                <strong>${vehicle.nm || vehicle.id}</strong><br>
                ${posText}
              </div>
            `;
          });
          resultHtml += '</div>';
        }

        resultDiv.innerHTML = resultHtml;
        
        if (success) {
          log(`‚úÖ –§–ª–∞–≥ ${flagInfo.flag}: ${withPosition} –∏–∑ ${vehicles.length} —Å –ø–æ–∑–∏—Ü–∏—è–º–∏`, 'success');
        } else {
          log(`‚ùå –§–ª–∞–≥ ${flagInfo.flag}: –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π`, 'error');
        }
        
      } catch (error) {
        resultDiv.innerHTML = `<div class="test-result error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        log(`üí• –§–ª–∞–≥ ${flagInfo.flag}: ${error.message}`, 'error');
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–µ—Å—Ç–æ–≤
    function createTestCards() {
      const grid = document.getElementById('testGrid');
      grid.innerHTML = '';
      
      flagTests.forEach(flagInfo => {
        const card = document.createElement('div');
        card.className = 'test-card';
        card.id = `test-${flagInfo.flag}`;
        
        card.innerHTML = `
          <h4>${flagInfo.name}</h4>
          <div class="flag-info">
            <strong>–§–ª–∞–≥:</strong> ${flagInfo.flag}<br>
            <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${flagInfo.description}
          </div>
          <button class="btn" onclick="testFlag(${JSON.stringify(flagInfo).replace(/"/g, '&quot;')})">
            üß™ –¢–µ—Å—Ç —Ñ–ª–∞–≥–∞
          </button>
          <div class="test-result"></div>
        `;
        
        grid.appendChild(card);
      });
    }

    // –¢–µ—Å—Ç –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤
    async function testAllFlags() {
      log('=== –¢–ï–°–¢ –í–°–ï–• –§–õ–ê–ì–û–í ===');
      showStatus('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π...', 'loading');
      
      createTestCards();
      
      try {
        await login();
        
        // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–ª–∞–≥–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
        for (const flagInfo of flagTests) {
          await testFlag(flagInfo);
          await new Promise(resolve => setTimeout(resolve, 1000)); // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
        }
        
        showStatus('‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ', 'success');
        log('üéâ –í–°–ï –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ï–ù–´', 'success');
        
      } catch (error) {
        showStatus(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
        log(`üí• –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      document.getElementById('testGrid').innerHTML = '';
      session = null;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function() {
      log('üéØ –¢–µ—Å—Ç —Ñ–ª–∞–≥–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –≥–æ—Ç–æ–≤!');
      log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 30)}...`);
      log(`–°–µ—Ä–≤–µ—Ä: ${serverHost}`);
      log('–ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤" –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è');
      
      createTestCards();
    };
  </script>
</body>

</html>
