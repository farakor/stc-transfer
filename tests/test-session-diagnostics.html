<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π Wialon</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .warning-block {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    .session-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border: 1px solid #dee2e6;
    }

    .session-active {
      border-left: 4px solid #28a745;
      background: #d4edda;
    }

    .session-expired {
      border-left: 4px solid #dc3545;
      background: #f8d7da;
    }

    .timeline {
      margin: 20px 0;
    }

    .timeline-item {
      padding: 10px;
      margin: 5px 0;
      border-left: 3px solid #dee2e6;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 12px;
    }

    .timeline-item.success {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .timeline-item.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .timeline-item.warning {
      border-left-color: #ffc107;
      background: #fff3cd;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π Wialon</h1>
    
    <div class="info-block">
      <strong>üéØ –¶–µ–ª—å:</strong> –í—ã—è—Å–Ω–∏—Ç—å –ø–æ—á–µ–º—É —Å–µ—Å—Å–∏–∏ –±—ã—Å—Ç—Ä–æ –∏—Å—Ç–µ–∫–∞—é—Ç –∏ –∫–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å<br>
      <strong>üîë –¢–æ–∫–µ–Ω:</strong> 85991e5f06896e98fe3c0bd49d2fe6d825770468546E156C3088DF44EB44163B2A478841<br>
      <strong>üåê –°–µ—Ä–≤–µ—Ä:</strong> gps.ent-en.com
    </div>

    <div class="warning-block">
      <strong>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞:</strong> –û—à–∏–±–∫–∞ 4 (Invalid session) –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ<br>
      <strong>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:</strong> –ü—Ä–æ–≤–µ—Ä–∏–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏ –∏ –Ω–∞–π–¥–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ -->
    <div class="session-info" id="sessionInfo">
      <strong>üìä –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è:</strong><br>
      <span id="sessionStatus">–ù–µ —Å–æ–∑–¥–∞–Ω–∞</span>
    </div>

    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="runSessionDiagnostics()">üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π</button>
      <button class="btn" onclick="testSessionLifetime()">‚è±Ô∏è –¢–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏</button>
      <button class="btn" onclick="testWithRetries()">üîÑ –¢–µ—Å—Ç —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div id="status"></div>

    <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ -->
    <div class="timeline" id="timeline"></div>

    <div id="log"></div>
  </div>

  <script>
    const serverHost = 'gps.ent-en.com';
    const token = '85991e5f06896e98fe3c0bd49d2fe6d825770468546E156C3088DF44EB44163B2A478841';
    let session = null;
    let sessionStartTime = null;
    let testStartTime = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function addTimelineEvent(message, type = 'info') {
      const timeline = document.getElementById('timeline');
      const timelineItem = document.createElement('div');
      timelineItem.className = `timeline-item ${type}`;
      
      const elapsed = sessionStartTime ? Math.floor((Date.now() - sessionStartTime) / 1000) : 0;
      timelineItem.innerHTML = `<strong>[+${elapsed}s]</strong> ${message}`;
      
      timeline.appendChild(timelineItem);
      timeline.scrollTop = timeline.scrollHeight;
    }

    function updateSessionInfo() {
      const sessionInfoDiv = document.getElementById('sessionInfo');
      const sessionStatusSpan = document.getElementById('sessionStatus');
      
      if (session) {
        const elapsed = sessionStartTime ? Math.floor((Date.now() - sessionStartTime) / 1000) : 0;
        sessionInfoDiv.className = 'session-info session-active';
        sessionStatusSpan.innerHTML = `
          ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞<br>
          <small>SID: ${session.sid}</small><br>
          <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}</small><br>
          <small>–í—Ä–µ–º—è –∂–∏–∑–Ω–∏: ${elapsed} —Å–µ–∫—É–Ω–¥</small>
        `;
      } else {
        sessionInfoDiv.className = 'session-info session-expired';
        sessionStatusSpan.innerHTML = '‚ùå –ù–µ —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞';
      }
    }

    // JSONP –∑–∞–ø—Ä–æ—Å —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
    function makeJsonpRequest(service, params, sid) {
      return new Promise((resolve, reject) => {
        const requestStart = Date.now();
        const callbackName = 'wialonCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        addTimelineEvent(`üì§ –ó–∞–ø—Ä–æ—Å: ${service}${sid ? ` (SID: ${sid.substring(0, 8)}...)` : ''}`, 'info');
        
        window[callbackName] = function(data) {
          const requestTime = Date.now() - requestStart;
          
          try {
            if (data.error) {
              addTimelineEvent(`‚ùå –û—à–∏–±–∫–∞ ${data.error}: ${service} (${requestTime}ms)`, 'error');
              reject(new Error(`Wialon API Error: ${data.error}`));
            } else {
              addTimelineEvent(`‚úÖ –£—Å–ø–µ—Ö: ${service} (${requestTime}ms)`, 'success');
              resolve(data);
            }
          } catch (error) {
            addTimelineEvent(`üí• –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
            reject(error);
          } finally {
            delete window[callbackName];
            const script = document.getElementById(`jsonp-${callbackName}`);
            if (script) script.remove();
          }
        };

        let url = `https://${serverHost}/wialon/ajax.html?svc=${service}`;
        if (sid) url += `&sid=${sid}`;
        url += `&params=${encodeURIComponent(JSON.stringify(params))}`;
        url += `&callback=${callbackName}`;

        const script = document.createElement('script');
        script.id = `jsonp-${callbackName}`;
        script.src = url;
        
        script.onerror = () => {
          addTimelineEvent(`üåê –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSONP: ${service}`, 'error');
          delete window[callbackName];
          reject(new Error('JSONP request failed'));
        };

        setTimeout(() => {
          if (window[callbackName]) {
            addTimelineEvent(`‚è±Ô∏è –¢–∞–π–º–∞—É—Ç: ${service}`, 'warning');
            delete window[callbackName];
            if (script) script.remove();
            reject(new Error('JSONP timeout'));
          }
        }, 15000);

        document.head.appendChild(script);
      });
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
    async function login() {
      log('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
      addTimelineEvent('üîê –ù–∞—á–∞–ª–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'info');
      
      try {
        const response = await makeJsonpRequest('token/login', { token: token });
        
        session = {
          sid: response.eid,
          userName: response.user?.nm || 'Unknown',
          userId: response.user?.id || 0
        };
        
        sessionStartTime = Date.now();
        updateSessionInfo();
        
        log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! SID: ${session.sid}`, 'success');
        addTimelineEvent(`‚úÖ –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${session.userName}`, 'success');
        
        return session;
      } catch (error) {
        session = null;
        sessionStartTime = null;
        updateSessionInfo();
        
        log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
        addTimelineEvent(`‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: ${error.message}`, 'error');
        throw error;
      }
    }

    // –¢–µ—Å—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏
    async function makeRequestWithRetry(service, params, maxRetries = 3) {
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          if (!session) {
            addTimelineEvent(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}: –ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è`, 'warning');
            await login();
          }
          
          addTimelineEvent(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}: ${service}`, 'info');
          const result = await makeJsonpRequest(service, params, session.sid);
          
          addTimelineEvent(`‚úÖ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}: –£—Å–ø–µ—Ö`, 'success');
          return result;
          
        } catch (error) {
          if (error.message.includes('Wialon API Error: 4')) {
            addTimelineEvent(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}: –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞`, 'warning');
            session = null;
            sessionStartTime = null;
            updateSessionInfo();
            
            if (attempt < maxRetries) {
              addTimelineEvent(`üîÑ –ü–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –ø–æ–ø—ã—Ç–∫–æ–π ${attempt + 1}`, 'warning');
              await new Promise(resolve => setTimeout(resolve, 1000));
              continue;
            }
          }
          
          addTimelineEvent(`‚ùå –ü–æ–ø—ã—Ç–∫–∞ ${attempt}: ${error.message}`, 'error');
          if (attempt === maxRetries) {
            throw error;
          }
        }
      }
    }

    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π
    async function runSessionDiagnostics() {
      log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ï–°–°–ò–ô ===');
      showStatus('üîç –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–µ—Å—Å–∏–π...', 'loading');
      
      testStartTime = Date.now();
      document.getElementById('timeline').innerHTML = '';

      try {
        // –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        addTimelineEvent('üöÄ –ù–∞—á–∞–ª–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏', 'info');
        await login();
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // –®–∞–≥ 2: –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç —Å–µ—Å—Å–∏–∏
        addTimelineEvent('üß™ –¢–µ—Å—Ç 1: –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—Ä–æ—Å', 'info');
        await makeJsonpRequest('core/search_items', {
          spec: { itemsType: 'avl_unit', propName: 'sys_name', propValueMask: '*', sortType: 'sys_name' },
          force: 1, flags: 1, from: 0, to: 0
        }, session.sid);
        
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        // –®–∞–≥ 3: –¢–µ—Å—Ç –ø–æ—Å–ª–µ –ø–∞—É–∑—ã
        addTimelineEvent('üß™ –¢–µ—Å—Ç 2: –ü–æ—Å–ª–µ –ø–∞—É–∑—ã 3 —Å–µ–∫', 'info');
        await makeJsonpRequest('core/search_items', {
          spec: { itemsType: 'avl_unit', propName: 'sys_name', propValueMask: '*', sortType: 'sys_name' },
          force: 1, flags: 1, from: 0, to: 0
        }, session.sid);
        
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        // –®–∞–≥ 4: –¢–µ—Å—Ç –ø–æ—Å–ª–µ –¥–ª–∏–Ω–Ω–æ–π –ø–∞—É–∑—ã
        addTimelineEvent('üß™ –¢–µ—Å—Ç 3: –ü–æ—Å–ª–µ –ø–∞—É–∑—ã 5 —Å–µ–∫', 'info');
        await makeJsonpRequest('core/search_items', {
          spec: { itemsType: 'avl_unit', propName: 'sys_name', propValueMask: '*', sortType: 'sys_name' },
          force: 1, flags: 1, from: 0, to: 0
        }, session.sid);
        
        const totalTime = Math.floor((Date.now() - testStartTime) / 1000);
        addTimelineEvent(`üéâ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${totalTime} —Å–µ–∫—É–Ω–¥`, 'success');
        
        showStatus(`‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–µ—Å—Å–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞ ${totalTime} —Å–µ–∫—É–Ω–¥`, 'success');
        log(`üéä –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –£–°–ü–ï–®–ù–ê: –°–µ—Å—Å–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ!`, 'success');
        
      } catch (error) {
        const totalTime = Math.floor((Date.now() - testStartTime) / 1000);
        addTimelineEvent(`üí• –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ ${totalTime} —Å–µ–∫—É–Ω–¥`, 'error');
        
        showStatus(`‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: ${error.message}`, 'error');
        log(`üí• –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–í–ê–õ–ï–ù–ê: ${error.message}`, 'error');
      }
    }

    // –¢–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏
    async function testSessionLifetime() {
      log('=== –¢–ï–°–¢ –í–†–ï–ú–ï–ù–ò –ñ–ò–ó–ù–ò –°–ï–°–°–ò–ò ===');
      showStatus('‚è±Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏...', 'loading');
      
      testStartTime = Date.now();
      document.getElementById('timeline').innerHTML = '';

      try {
        await login();
        
        // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
        let testNumber = 1;
        while (true) {
          await new Promise(resolve => setTimeout(resolve, 10000)); // 10 —Å–µ–∫—É–Ω–¥
          
          addTimelineEvent(`üß™ –¢–µ—Å—Ç ${testNumber}: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏`, 'info');
          await makeJsonpRequest('core/search_items', {
            spec: { itemsType: 'avl_unit', propName: 'sys_name', propValueMask: '*', sortType: 'sys_name' },
            force: 1, flags: 1, from: 0, to: 0
          }, session.sid);
          
          testNumber++;
          
          if (testNumber > 20) { // –ú–∞–∫—Å–∏–º—É–º 200 —Å–µ–∫—É–Ω–¥
            addTimelineEvent('‚è∞ –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (200 —Å–µ–∫)', 'warning');
            break;
          }
        }
        
      } catch (error) {
        const sessionLifetime = sessionStartTime ? Math.floor((Date.now() - sessionStartTime) / 1000) : 0;
        addTimelineEvent(`‚è±Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ —á–µ—Ä–µ–∑ ${sessionLifetime} —Å–µ–∫—É–Ω–¥`, 'warning');
        
        showStatus(`‚è±Ô∏è –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏: ${sessionLifetime} —Å–µ–∫—É–Ω–¥`, 'error');
        log(`‚è±Ô∏è –í–†–ï–ú–Ø –ñ–ò–ó–ù–ò –°–ï–°–°–ò–ò: ${sessionLifetime} —Å–µ–∫—É–Ω–¥`, 'error');
      }
    }

    // –¢–µ—Å—Ç —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏
    async function testWithRetries() {
      log('=== –¢–ï–°–¢ –° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ú–ò –ü–û–í–¢–û–†–ê–ú–ò ===');
      showStatus('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏...', 'loading');
      
      testStartTime = Date.now();
      document.getElementById('timeline').innerHTML = '';

      try {
        addTimelineEvent('üöÄ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞ —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏', 'info');
        
        // –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏
        const vehicles = await makeRequestWithRetry('core/search_items', {
          spec: { itemsType: 'avl_unit', propName: 'sys_name', propValueMask: '*', sortType: 'sys_name' },
          force: 1, flags: 1, from: 0, to: 0
        });
        
        addTimelineEvent(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${vehicles.items?.length || 0}`, 'success');
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // –¢–µ—Å—Ç 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏
        if (vehicles.items && vehicles.items.length > 0) {
          const vehicleIds = vehicles.items.slice(0, 3).map(v => v.id);
          
          await makeRequestWithRetry('core/update_data_flags', {
            spec: vehicleIds.map(id => ({ type: 'id', data: id, flags: 3 }))
          });
          
          addTimelineEvent(`‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è ${vehicleIds.length} –µ–¥–∏–Ω–∏—Ü`, 'success');
        }
        
        const totalTime = Math.floor((Date.now() - testStartTime) / 1000);
        addTimelineEvent(`üéâ –¢–µ—Å—Ç —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ ${totalTime} —Å–µ–∫—É–Ω–¥`, 'success');
        
        showStatus(`‚úÖ –¢–µ—Å—Ç —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ —É—Å–ø–µ—à–µ–Ω! –í—Ä–µ–º—è: ${totalTime} —Å–µ–∫—É–Ω–¥`, 'success');
        log(`üéä –¢–ï–°–¢ –° –ü–û–í–¢–û–†–ê–ú–ò –£–°–ü–ï–®–ï–ù!`, 'success');
        
      } catch (error) {
        const totalTime = Math.floor((Date.now() - testStartTime) / 1000);
        addTimelineEvent(`üí• –¢–µ—Å—Ç —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω —á–µ—Ä–µ–∑ ${totalTime} —Å–µ–∫—É–Ω–¥`, 'error');
        
        showStatus(`‚ùå –¢–µ—Å—Ç —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`, 'error');
        log(`üí• –¢–ï–°–¢ –° –ü–û–í–¢–û–†–ê–ú–ò –ü–†–û–í–ê–õ–ï–ù: ${error.message}`, 'error');
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      document.getElementById('timeline').innerHTML = '';
      session = null;
      sessionStartTime = null;
      testStartTime = null;
      updateSessionInfo();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(updateSessionInfo, 1000);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function() {
      log('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π Wialon –≥–æ—Ç–æ–≤–∞!');
      log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 30)}...`);
      log(`–°–µ—Ä–≤–µ—Ä: ${serverHost}`);
      log('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞');
      updateSessionInfo();
    };
  </script>
</body>

</html>
