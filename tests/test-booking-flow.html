<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ - STC Transfer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-900">
      üöó –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
    </h1>

    <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>

      <form id="bookingForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Telegram ID (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
          </label>
          <input type="number" id="telegramId" value="12345" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            –û—Ç–∫—É–¥–∞
          </label>
          <input type="text" id="fromLocation" value="–°–∞–º–∞—Ä–∫–∞–Ω–¥" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            –ö—É–¥–∞
          </label>
          <input type="text" id="toLocation" value="–¢–∞—à–∫–µ–Ω—Ç" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            –¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
          </label>
          <select id="vehicleType" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="SEDAN">–°–µ–¥–∞–Ω</option>
            <option value="PREMIUM">–ü—Ä–µ–º–∏—É–º</option>
            <option value="MINIVAN">–ú–∏–Ω–∏–≤—ç–Ω</option>
            <option value="MICROBUS">–ú–∏–∫—Ä–æ–∞–≤—Ç–æ–±—É—Å</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            –í—Ä–µ–º—è –ø–æ–¥–∞—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          </label>
          <input type="datetime-local" id="pickupTime"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          </label>
          <textarea id="notes" rows="3" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <button type="submit" id="submitBtn"
          class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
          <span id="submitText">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</span>
          <div id="submitLoader"
            class="hidden loading inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full ml-2">
          </div>
        </button>
      </form>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div id="result" class="hidden">
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-green-800 mb-2">‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!</h3>
        <div id="bookingDetails" class="text-sm text-green-700"></div>
      </div>
    </div>

    <!-- –û—à–∏–±–∫–∏ -->
    <div id="error" class="hidden">
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-red-800 mb-2">‚ùå –û—à–∏–±–∫–∞</h3>
        <div id="errorMessage" class="text-sm text-red-700"></div>
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
        <button onclick="loadActiveBookings()"
          class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>

      <div id="activeBookings">
        <div class="text-center text-gray-500 py-4">
          –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤
        </div>
      </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="mt-6 grid grid-cols-2 gap-4">
      <a href="/admin/dashboard"
        class="block bg-purple-600 text-white text-center py-3 px-4 rounded-md hover:bg-purple-700 transition-colors">
        üè† –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
      </a>
      <a href="/"
        class="block bg-blue-600 text-white text-center py-3 px-4 rounded-md hover:bg-blue-700 transition-colors">
        üì± –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      </a>
    </div>
  </div>

  <script>
    const API_BASE = '/api';

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (+1 —á–∞—Å –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
    document.addEventListener('DOMContentLoaded', function () {
      const now = new Date();
      now.setHours(now.getHours() + 1);
      document.getElementById('pickupTime').value = now.toISOString().slice(0, 16);

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      loadActiveBookings();
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    document.getElementById('bookingForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      const submitLoader = document.getElementById('submitLoader');
      const resultDiv = document.getElementById('result');
      const errorDiv = document.getElementById('error');

      // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      submitBtn.disabled = true;
      submitText.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...';
      submitLoader.classList.remove('hidden');
      resultDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');

      try {
        const formData = {
          telegramId: parseInt(document.getElementById('telegramId').value),
          fromLocation: document.getElementById('fromLocation').value,
          toLocation: document.getElementById('toLocation').value,
          vehicleType: document.getElementById('vehicleType').value,
          pickupTime: document.getElementById('pickupTime').value || undefined,
          notes: document.getElementById('notes').value || undefined,
          distanceKm: 280 // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –°–∞–º–∞—Ä–∫–∞–Ω–¥-–¢–∞—à–∫–µ–Ω—Ç
        };

        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞:', formData);

        const response = await fetch(`${API_BASE}/bookings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);

        if (result.success) {
          // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          document.getElementById('bookingDetails').innerHTML = `
                        <p><strong>ID –∑–∞–∫–∞–∑–∞:</strong> ${result.data.id}</p>
                        <p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${result.data.fromLocation} ‚Üí ${result.data.toLocation}</p>
                        <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${result.data.price} —Å—É–º</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.data.status}</p>
                        <p><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(result.data.createdAt).toLocaleString('ru-RU')}</p>
                    `;
          resultDiv.classList.remove('hidden');

          // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
          setTimeout(() => {
            loadActiveBookings();
          }, 1000);
        } else {
          throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
        document.getElementById('errorMessage').textContent = error.message;
        errorDiv.classList.remove('hidden');
      } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
        submitBtn.disabled = false;
        submitText.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑';
        submitLoader.classList.add('hidden');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    async function loadActiveBookings() {
      const container = document.getElementById('activeBookings');
      container.innerHTML = '<div class="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

      try {
        const response = await fetch(`${API_BASE}/bookings/active`);
        const result = await response.json();

        if (result.success && result.data && result.data.length > 0) {
          container.innerHTML = result.data.map(booking => `
                        <div class="border border-gray-200 rounded-lg p-4 mb-3">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">
                                        #${booking.id.slice(0, 8)}... 
                                        <span class="text-sm px-2 py-1 rounded-full ${getStatusClass(booking.status)}">
                                            ${getStatusText(booking.status)}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        üìç ${booking.fromLocation} ‚Üí ${booking.toLocation}
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        üë§ ${booking.user.name || '–ö–ª–∏–µ–Ω—Ç'} | üí∞ ${booking.price} —Å—É–º
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        üïí ${new Date(booking.createdAt).toLocaleString('ru-RU')}
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    ${booking.status === 'PENDING' ? `
                                        <button onclick="assignDriver('${booking.id}')" 
                                                class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                                            –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                        </button>
                                        <button onclick="cancelBooking('${booking.id}')" 
                                                class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                                            –û—Ç–º–µ–Ω–∏—Ç—å
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
        } else {
          container.innerHTML = '<div class="text-center text-gray-500 py-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
        container.innerHTML = '<div class="text-center text-red-500 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
      }
    }

    // –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è
    async function assignDriver(bookingId) {
      if (!confirm('–ù–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è "–ò–±—Ä–∞–≥–∏–º –ê–∑–∏–∑–æ–≤" –Ω–∞ —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/bookings/${bookingId}/assign-driver`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ driverId: '1' })
        });

        const result = await response.json();

        if (result.success) {
          alert('‚úÖ –í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω! –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
          loadActiveBookings();
        } else {
          alert('‚ùå –û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è');
      }
    }

    // –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
    async function cancelBooking(bookingId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/bookings/${bookingId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            status: 'cancelled',
            notes: '–û—Ç–º–µ–Ω–µ–Ω–æ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—É—é –ø–∞–Ω–µ–ª—å'
          })
        });

        const result = await response.json();

        if (result.success) {
          alert('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω! –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
          loadActiveBookings();
        } else {
          alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞');
      }
    }

    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
    function getStatusClass(status) {
      switch (status) {
        case 'PENDING': return 'bg-yellow-100 text-yellow-800';
        case 'CONFIRMED': return 'bg-blue-100 text-blue-800';
        case 'IN_PROGRESS': return 'bg-purple-100 text-purple-800';
        case 'COMPLETED': return 'bg-green-100 text-green-800';
        case 'CANCELLED': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function getStatusText(status) {
      switch (status) {
        case 'PENDING': return '–û–∂–∏–¥–∞–µ—Ç';
        case 'CONFIRMED': return '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
        case 'IN_PROGRESS': return '–í –ø—É—Ç–∏';
        case 'COMPLETED': return '–ó–∞–≤–µ—Ä—à–µ–Ω';
        case 'CANCELLED': return '–û—Ç–º–µ–Ω–µ–Ω';
        default: return status;
      }
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    setInterval(loadActiveBookings, 10000);
  </script>
</body>

</html>