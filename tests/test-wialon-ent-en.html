<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç Wialon API - gps.ent-en.com</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .warning-block {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .token-info {
      background: #d4edda;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #28a745;
    }

    .api-test {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 3px solid #007bff;
    }

    .api-test.success {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .api-test.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .api-test.loading {
      border-left-color: #ffc107;
      background: #fff3cd;
    }

    .code-block {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      margin: 10px 0;
      border: 1px solid #dee2e6;
    }

    .vehicle-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .vehicle-item {
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #28a745;
    }

    .vehicle-offline {
      border-left-color: #dc3545;
    }

    .vehicle-moving {
      border-left-color: #28a745;
    }

    .vehicle-stopped {
      border-left-color: #ffc107;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #0056b3);
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîë –¢–µ—Å—Ç Wialon API - gps.ent-en.com</h1>
    
    <div class="token-info">
      <strong>üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ gps.ent-en.com</strong><br>
      <small>–°–µ—Ä–≤–µ—Ä: gps.ent-en.com</small><br>
      <small>–¢–æ–∫–µ–Ω: 85991e5f06896e98fe3c0bd49d2fe6d8EC2B0F5F2A7A963F0EC0B869EB87FF8188C6EE8D</small><br>
      <small>API URL: –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
    </div>

    <div class="info-block">
      <strong>üìö –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong><br>
      1. <code>https://gps.ent-en.com/wialon/ajax.html</code> - HTTPS —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º API<br>
      2. <code>http://gps.ent-en.com/wialon/ajax.html</code> - HTTP —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º API<br>
      3. <code>https://gps.ent-en.com/ajax.html</code> - HTTPS –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å<br>
      4. <code>http://gps.ent-en.com/ajax.html</code> - HTTP –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å<br>
      5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
    </div>

    <div class="warning-block">
      <strong>‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Wialon, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <code>{host}/wialon/ajax.html</code>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="testAllVariants()">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</button>
      <button class="btn" onclick="testServerAvailability()">üåê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
      <button class="btn" onclick="getVehicles()" id="vehiclesBtn" disabled>üöå –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="progress-bar" style="display: none;" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div id="progressText" style="text-align: center; font-size: 12px; color: #666;"></div>

    <!-- –¢–µ—Å—Ç—ã API -->
    <div id="apiTests">
      <div class="api-test" id="test-https-wialon">
        <strong>–¢–µ—Å—Ç 1: HTTPS + /wialon/ajax.html (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</strong>
        <div class="code-block">URL: https://gps.ent-en.com/wialon/ajax.html?svc=token/login</div>
        <div id="result-https-wialon"></div>
      </div>
      
      <div class="api-test" id="test-http-wialon">
        <strong>–¢–µ—Å—Ç 2: HTTP + /wialon/ajax.html</strong>
        <div class="code-block">URL: http://gps.ent-en.com/wialon/ajax.html?svc=token/login</div>
        <div id="result-http-wialon"></div>
      </div>
      
      <div class="api-test" id="test-https-ajax">
        <strong>–¢–µ—Å—Ç 3: HTTPS + /ajax.html (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)</strong>
        <div class="code-block">URL: https://gps.ent-en.com/ajax.html?svc=token/login</div>
        <div id="result-https-ajax"></div>
      </div>
      
      <div class="api-test" id="test-http-ajax">
        <strong>–¢–µ—Å—Ç 4: HTTP + /ajax.html (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)</strong>
        <div class="code-block">URL: http://gps.ent-en.com/ajax.html?svc=token/login</div>
        <div id="result-http-ajax"></div>
      </div>
      
      <div class="api-test" id="test-server">
        <strong>–¢–µ—Å—Ç 5: –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞</strong>
        <div class="code-block">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ gps.ent-en.com</div>
        <div id="result-server"></div>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="status"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="results"></div>

    <!-- –õ–æ–≥–∏ -->
    <div id="log"></div>
  </div>

  <script>
    const serverHost = 'gps.ent-en.com';
    const token = '85991e5f06896e98fe3c0bd49d2fe6d8EC2B0F5F2A7A963F0EC0B869EB87FF8188C6EE8D';
    let session = null;
    let vehicles = [];

    const testVariants = [
      { id: 'https-wialon', url: `https://${serverHost}/wialon/ajax.html`, name: 'HTTPS + /wialon/ajax.html' },
      { id: 'http-wialon', url: `http://${serverHost}/wialon/ajax.html`, name: 'HTTP + /wialon/ajax.html' },
      { id: 'https-ajax', url: `https://${serverHost}/ajax.html`, name: 'HTTPS + /ajax.html' },
      { id: 'http-ajax', url: `http://${serverHost}/ajax.html`, name: 'HTTP + /ajax.html' }
    ];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function updateProgress(current, total, text) {
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressBar.style.display = 'block';
      const percentage = (current / total) * 100;
      progressFill.style.width = `${percentage}%`;
      progressText.textContent = `${text} (${current}/${total})`;
    }

    function hideProgress() {
      document.getElementById('progressBar').style.display = 'none';
      document.getElementById('progressText').textContent = '';
    }

    function updateTestResult(testId, status, message) {
      const testDiv = document.getElementById(`test-${testId}`);
      const resultDiv = document.getElementById(`result-${testId}`);
      
      testDiv.className = `api-test ${status}`;
      resultDiv.innerHTML = `<small>${message}</small>`;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
    async function testServerAvailability() {
      log('=== –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò –°–ï–†–í–ï–†–ê ===');
      updateTestResult('server', 'loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...');

      const urls = [
        `https://${serverHost}`,
        `http://${serverHost}`,
        `https://${serverHost}/wialon`,
        `http://${serverHost}/wialon`
      ];

      for (const url of urls) {
        try {
          log(`–ü—Ä–æ–≤–µ—Ä–∫–∞: ${url}`);
          const response = await fetch(url, { 
            method: 'HEAD', 
            mode: 'no-cors',
            timeout: 5000 
          });
          
          updateTestResult('server', 'success', `‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω: ${url}`);
          log(`‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω: ${url}`, 'success');
          return true;
        } catch (error) {
          log(`‚ùå ${url}: ${error.message}`, 'error');
        }
      }

      updateTestResult('server', 'error', '‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –≤—Å–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º');
      log('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
      return false;
    }

    // –¢–µ—Å—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ API URL
    async function testApiUrl(variant) {
      log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${variant.name} - ${variant.url}`);
      updateTestResult(variant.id, 'loading', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...');

      try {
        const response = await fetch(`${variant.url}?svc=token/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `params=${JSON.stringify({ token: token })}`
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(`Wialon Error: ${data.error}`);
        }

        session = {
          sid: data.eid,
          userId: data.user?.id || 0,
          userName: data.user?.nm || 'Unknown',
          apiUrl: variant.url
        };

        updateTestResult(variant.id, 'success', `‚úÖ –£—Å–ø–µ—Ö! SID: ${session.sid}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`);
        log(`‚úÖ ${variant.name} —Ä–∞–±–æ—Ç–∞–µ—Ç! SID: ${session.sid}`, 'success');
        
        return true;

      } catch (error) {
        updateTestResult(variant.id, 'error', `‚ùå ${error.message}`);
        log(`‚ùå ${variant.name} –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${error.message}`, 'error');
        return false;
      }
    }

    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    async function testAllVariants() {
      log('=== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –í–°–ï–• –í–ê–†–ò–ê–ù–¢–û–í gps.ent-en.com ===');
      showStatus('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'loading');

      // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
      session = null;
      vehicles = [];
      document.getElementById('vehiclesBtn').disabled = true;

      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
      await testServerAvailability();
      await new Promise(resolve => setTimeout(resolve, 1000));

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç API
      for (let i = 0; i < testVariants.length; i++) {
        const variant = testVariants[i];
        updateProgress(i + 1, testVariants.length, `–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${variant.name}`);
        
        const success = await testApiUrl(variant);
        
        if (success) {
          showStatus(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑ ${variant.name}! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}`, 'success');
          document.getElementById('vehiclesBtn').disabled = false;
          hideProgress();
          return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —Ä–∞–±–æ—á–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ
        }
        
        // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      hideProgress();
      
      if (!session) {
        showStatus('‚ùå –ù–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error');
        log('=== –í–°–ï –í–ê–†–ò–ê–ù–¢–´ –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–´ - –ù–ò –û–î–ò–ù –ù–ï –†–ê–ë–û–¢–ê–ï–¢ ===', 'error');
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    async function getVehicles() {
      if (!session) {
        showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é', 'error');
        return;
      }

      log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –°–ü–ò–°–ö–ê –¢–†–ê–ù–°–ü–û–†–¢–ê ===');
      showStatus('üöå –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...', 'loading');

      try {
        const response = await fetch(`${session.apiUrl}?svc=core/search_items&sid=${session.sid}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `params=${JSON.stringify({
            spec: {
              itemsType: 'avl_unit',
              propName: 'sys_name',
              propValueMask: '*',
              sortType: 'sys_name'
            },
            force: 1,
            flags: 0x1,
            from: 0,
            to: 0
          })}`
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        vehicles = data.items || [];
        log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${vehicles.length}`, 'success');

        if (vehicles.length === 0) {
          showStatus('‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
          return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
        await updateVehiclePositions();
        displayVehicles();
        showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`, 'success');

      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    async function updateVehiclePositions() {
      if (!vehicles.length || !session) return;

      try {
        log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');
        
        const vehicleIds = vehicles.map(v => v.id);
        const response = await fetch(`${session.apiUrl}?svc=core/update_data_flags&sid=${session.sid}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `params=${JSON.stringify({
            spec: vehicleIds.map(id => ({
              type: 'id',
              data: id,
              flags: 0x1 | 0x2
            }))
          })}`
        });

        const data = await response.json();
        log('‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');

      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π: ${error.message}`, 'error');
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    function displayVehicles() {
      const resultsDiv = document.getElementById('results');
      
      if (!vehicles.length) {
        resultsDiv.innerHTML = '';
        return;
      }

      let html = '<h3>üöå –í–∞—à —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</h3><div class="vehicle-list">';
      const now = Math.floor(Date.now() / 1000);

      let online = 0, moving = 0, stopped = 0;

      vehicles.forEach(vehicle => {
        const pos = vehicle.pos;
        const isOnline = pos && (now - pos.t) < 600;
        const speed = pos?.s || 0;
        let status = '–û—Ñ—Ñ–ª–∞–π–Ω';
        let statusClass = 'vehicle-offline';
        
        if (isOnline) {
          online++;
          if (speed > 5) {
            status = '–í –¥–≤–∏–∂–µ–Ω–∏–∏';
            statusClass = 'vehicle-moving';
            moving++;
          } else {
            status = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞';
            statusClass = 'vehicle-stopped';
            stopped++;
          }
        }

        html += `
          <div class="vehicle-item ${statusClass}">
            <strong>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</strong><br>
            <small>
              ID: ${vehicle.id} | –°—Ç–∞—Ç—É—Å: ${status} | –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á<br>
              ${pos ? `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.y?.toFixed(6)}, ${pos.x?.toFixed(6)}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏'}<br>
              ${pos ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(pos.t * 1000).toLocaleString()}` : ''}
            </small>
          </div>
        `;
      });

      html += '</div>';
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      html += `
        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
          <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
          <small>
            –í—Å–µ–≥–æ: ${vehicles.length} | 
            –û–Ω–ª–∞–π–Ω: ${online} | 
            –í –¥–≤–∏–∂–µ–Ω–∏–∏: ${moving} | 
            –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ${stopped} | 
            –û—Ñ—Ñ–ª–∞–π–Ω: ${vehicles.length - online}
          </small>
        </div>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
      html += `
        <div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 6px;">
          <strong>‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ gps.ent-en.com —É—Å–ø–µ—à–Ω–æ!</strong><br>
          <small>API: ${session.apiUrl}</small><br>
          <small>SID: ${session.sid}</small><br>
          <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.userName}</small>
        </div>
      `;
      
      resultsDiv.innerHTML = html;
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      document.getElementById('vehiclesBtn').disabled = true;
      hideProgress();
      
      // –°–±—Ä–æ—Å —Ç–µ—Å—Ç–æ–≤
      testVariants.forEach(variant => {
        document.getElementById(`test-${variant.id}`).className = 'api-test';
        document.getElementById(`result-${variant.id}`).innerHTML = '';
      });
      document.getElementById('test-server').className = 'api-test';
      document.getElementById('result-server').innerHTML = '';
      
      session = null;
      vehicles = [];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function() {
      log('üåê –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ gps.ent-en.com –≥–æ—Ç–æ–≤!');
      log(`–°–µ—Ä–≤–µ—Ä: ${serverHost}`);
      log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 30)}...`);
      log('–ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã" –¥–ª—è –Ω–∞—á–∞–ª–∞');
    };
  </script>
</body>

</html>
