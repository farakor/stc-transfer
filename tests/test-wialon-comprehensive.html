<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wialon - AKhamraev</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.loading {
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #81d4fa;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .info-block {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-weight: 500;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn.success {
      background: #28a745;
    }

    .btn.success:hover {
      background: #218838;
    }

    .btn.large {
      padding: 15px 30px;
      font-size: 16px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #0056b3);
      width: 0%;
      transition: width 0.3s ease;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .test-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .test-card h4 {
      margin: 0 0 10px 0;
      color: #495057;
    }

    .test-result {
      padding: 10px;
      border-radius: 4px;
      margin: 5px 0;
      font-size: 12px;
    }

    .test-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .test-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .test-result.testing {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .vehicle-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .vehicle-item {
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #28a745;
    }

    .vehicle-offline {
      border-left-color: #dc3545;
    }

    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîç –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wialon</h1>
    <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É 176.74.220.111</p>

    <div class="info-block">
      <strong>–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong> AKhamraev / xamrayev11<br>
      <strong>–°–µ—Ä–≤–µ—Ä:</strong> 176.74.220.111<br>
      <strong>–°—Ç–∞—Ç—É—Å:</strong> –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Wialon
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
    <div style="text-align: center; margin: 20px 0;">
      <button class="btn large success" onclick="runFullTest()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
      <button class="btn" onclick="testQuickConnection()">‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div class="progress-bar" style="display: none;" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div id="progressText" style="text-align: center; font-size: 12px; color: #666;"></div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="status"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ -->
    <div class="test-grid" id="testResults"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="results"></div>

    <!-- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ -->
    <div id="log"></div>
  </div>

  <script>
    const credentials = {
      username: 'AKhamraev',
      password: 'xamrayev11'
    };

    // –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const testConfigs = [
      // HTTP –≤–∞—Ä–∏–∞–Ω—Ç—ã
      { name: 'HTTP —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π', url: 'http://176.74.220.111', priority: 1 },
      { name: 'HTTP –ø–æ—Ä—Ç 80', url: 'http://176.74.220.111:80', priority: 2 },
      { name: 'HTTP –ø–æ—Ä—Ç 8080', url: 'http://176.74.220.111:8080', priority: 3 },
      { name: 'HTTP –ø–æ—Ä—Ç 443', url: 'http://176.74.220.111:443', priority: 4 },
      { name: 'HTTP –ø–æ—Ä—Ç 8000', url: 'http://176.74.220.111:8000', priority: 5 },

      // HTTPS –≤–∞—Ä–∏–∞–Ω—Ç—ã
      { name: 'HTTPS —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π', url: 'https://176.74.220.111', priority: 6 },
      { name: 'HTTPS –ø–æ—Ä—Ç 443', url: 'https://176.74.220.111:443', priority: 7 },
      { name: 'HTTPS –ø–æ—Ä—Ç 8443', url: 'https://176.74.220.111:8443', priority: 8 },

      // –ü—Ä—è–º—ã–µ –ø—É—Ç–∏
      { name: 'HTTP –ø—Ä—è–º–æ–π –ø—É—Ç—å', url: 'http://176.74.220.111/wialon/ajax.html', priority: 9 },
      { name: 'HTTPS –ø—Ä—è–º–æ–π –ø—É—Ç—å', url: 'https://176.74.220.111/wialon/ajax.html', priority: 10 },

      // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏
      { name: 'HTTP /api', url: 'http://176.74.220.111/api', priority: 11 },
      { name: 'HTTP /wialon', url: 'http://176.74.220.111/wialon', priority: 12 }
    ];

    let session = null;
    let currentTestIndex = 0;
    let successfulConfig = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logEntry.style.margin = '2px 0';
      logEntry.style.padding = '3px';
      logEntry.style.borderRadius = '3px';
      logEntry.style.fontSize = '12px';

      switch (type) {
        case 'error':
          logEntry.style.background = '#ffebee';
          logEntry.style.color = '#c62828';
          break;
        case 'success':
          logEntry.style.background = '#e8f5e8';
          logEntry.style.color = '#2e7d32';
          break;
        default:
          logEntry.style.background = '#f8f9fa';
          logEntry.style.color = '#495057';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function updateProgress(current, total, text) {
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      progressBar.style.display = 'block';
      const percentage = (current / total) * 100;
      progressFill.style.width = `${percentage}%`;
      progressText.textContent = `${text} (${current}/${total})`;
    }

    function hideProgress() {
      document.getElementById('progressBar').style.display = 'none';
      document.getElementById('progressText').textContent = '';
    }

    async function makeRequest(baseUrl, svc, params = {}) {
      const apiUrl = baseUrl.includes('/wialon/ajax.html')
        ? baseUrl
        : `${baseUrl}/wialon/ajax.html`;

      const url = new URL(apiUrl);
      url.searchParams.set('svc', svc);

      if (session) {
        url.searchParams.set('sid', session.sid);
      }

      const body = new URLSearchParams();
      body.append('params', JSON.stringify(params));

      const response = await fetch(url.toString(), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: body.toString()
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      return await response.json();
    }

    async function testConnection(config) {
      try {
        const response = await makeRequest(config.url, 'core/login', {
          user: credentials.username,
          password: credentials.password
        });

        if (response.error) {
          throw new Error(response.error);
        }

        return {
          success: true,
          session: {
            sid: response.eid,
            userId: response.user?.id || 0,
            userName: response.user?.nm || 'Unknown'
          },
          response: response
        };
      } catch (error) {
        return {
          success: false,
          error: error.message
        };
      }
    }

    function displayTestResult(config, result, index) {
      const resultsDiv = document.getElementById('testResults');

      const testCard = document.createElement('div');
      testCard.className = 'test-card';
      testCard.innerHTML = `
        <h4>${config.name}</h4>
        <div><strong>URL:</strong> ${config.url}</div>
        <div class="test-result ${result.success ? 'success' : 'error'}">
          ${result.success
          ? `‚úÖ –£—Å–ø–µ—à–Ω–æ! SID: ${result.session.sid.substring(0, 10)}...`
          : `‚ùå –û—à–∏–±–∫–∞: ${result.error}`
        }
        </div>
        ${result.success ? `<div><small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${result.session.userName}</small></div>` : ''}
      `;

      resultsDiv.appendChild(testCard);
    }

    async function runFullTest() {
      log('=== –ó–ê–ü–£–°–ö –ü–û–õ–ù–û–ì–û –¢–ï–°–¢–ê ===');
      showStatus('üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'loading');

      document.getElementById('testResults').innerHTML = '';
      currentTestIndex = 0;
      successfulConfig = null;

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
      const sortedConfigs = [...testConfigs].sort((a, b) => a.priority - b.priority);

      for (let i = 0; i < sortedConfigs.length; i++) {
        const config = sortedConfigs[i];
        updateProgress(i + 1, sortedConfigs.length, `–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${config.name}`);

        log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${i + 1}/${sortedConfigs.length}: ${config.name}`);

        const result = await testConnection(config);
        displayTestResult(config, result, i);

        if (result.success && !successfulConfig) {
          successfulConfig = { config, result };
          session = result.session;

          log(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—á–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${config.name}`, 'success');
          showStatus(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${config.name}`, 'success');

          // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
          await testVehiclesList(config);
          break;
        }

        // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      hideProgress();

      if (!successfulConfig) {
        showStatus('‚ùå –ù–∏ –æ–¥–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error');
        log('=== –í–°–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ï–ù–´ ===', 'error');
      } else {
        log('=== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û ===', 'success');
      }
    }

    async function testQuickConnection() {
      log('=== –ë–´–°–¢–†–´–ô –¢–ï–°–¢ ===');
      showStatus('‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'loading');

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
      const quickConfigs = testConfigs.slice(0, 3);

      for (const config of quickConfigs) {
        log(`–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç: ${config.name}`);
        const result = await testConnection(config);

        if (result.success) {
          successfulConfig = { config, result };
          session = result.session;
          showStatus(`‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${config.name}`, 'success');
          await testVehiclesList(config);
          return;
        }
      }

      showStatus('‚ùå –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
    }

    async function testVehiclesList(config) {
      try {
        log('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');

        const searchResponse = await makeRequest(config.url, 'core/search_items', {
          spec: {
            itemsType: 'avl_unit',
            propName: 'sys_name',
            propValueMask: '*',
            sortType: 'sys_name'
          },
          force: 1,
          flags: 0x1,
          from: 0,
          to: 0
        });

        const vehicles = searchResponse.items || [];
        log(`–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${vehicles.length}`, 'success');

        if (vehicles.length > 0) {
          displayVehicles(vehicles);
        }

      } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
      }
    }

    function displayVehicles(vehicles) {
      const resultsDiv = document.getElementById('results');

      let html = '<div class="vehicle-list"><h3>üöå –ù–∞–π–¥–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</h3>';

      vehicles.forEach((vehicle, index) => {
        const pos = vehicle.pos;
        const isOnline = pos && (Math.floor(Date.now() / 1000) - pos.t) < 600;
        const speed = pos?.s || 0;
        const status = !isOnline ? '–û—Ñ—Ñ–ª–∞–π–Ω' : speed > 5 ? '–í –¥–≤–∏–∂–µ–Ω–∏–∏' : '–û—Å—Ç–∞–Ω–æ–≤–∫–∞';

        html += `
          <div class="vehicle-item ${!isOnline ? 'vehicle-offline' : ''}">
            <strong>${vehicle.nm || `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${vehicle.id}`}</strong><br>
            <small>
              ID: ${vehicle.id} | –°—Ç–∞—Ç—É—Å: ${status} | –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á<br>
              ${pos ? `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.y?.toFixed(6)}, ${pos.x?.toFixed(6)}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏'}
            </small>
          </div>
        `;
      });

      html += '</div>';
      resultsDiv.innerHTML = html;
    }

    function clearResults() {
      document.getElementById('testResults').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      hideProgress();
      session = null;
      successfulConfig = null;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function () {
      log('–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wialon');
      log(`–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${credentials.username} / ${credentials.password}`);
      log(`–ë—É–¥–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ ${testConfigs.length} –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π`);
    };
  </script>
</body>

</html>