<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç –º–æ–¥–∞–ª–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .booking {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      background: white;
    }

    .booking h3 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .booking-info {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }

    .info-item {
      padding: 5px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
    }

    .info-label {
      font-weight: bold;
      color: #666;
    }

    .assign-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    .assign-btn:hover {
      background: #0056b3;
    }

    .vehicle-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .vehicle-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: white;
    }

    .vehicle-card h4 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .vehicle-info {
      font-size: 14px;
      color: #666;
      margin: 5px 0;
    }

    .status-available {
      color: #28a745;
      font-weight: bold;
    }

    .status-busy {
      color: #dc3545;
      font-weight: bold;
    }

    .error {
      color: #dc3545;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }

    .success {
      color: #155724;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .filter-info {
      background: #e9ecef;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üöó –¢–µ—Å—Ç –º–æ–¥–∞–ª–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h1>

    <div id="loadingMessage" class="loading">
      –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div id="bookingsContainer" style="display: none;">
      <h2>üìã –ó–∞–∫–∞–∑—ã –æ–∂–∏–¥–∞—é—â–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h2>
      <div id="bookingsList"></div>
    </div>

    <div id="vehiclesContainer" style="display: none;">
      <h2>üöô –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</h2>
      <div class="filter-info">
        <strong>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:</strong> –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º AVAILABLE –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–º —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
        AVAILABLE
      </div>
      <div id="vehiclesList" class="vehicle-list"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3003/api';
    let bookings = [];
    let vehicles = [];

    function getVehicleTypeName(type) {
      const typeNames = {
        'SEDAN': '–°–µ–¥–∞–Ω',
        'PREMIUM': '–ü—Ä–µ–º–∏—É–º',
        'MINIVAN': '–ú–∏–Ω–∏–≤—ç–Ω',
        'MICROBUS': '–ú–∏–∫—Ä–æ–∞–≤—Ç–æ–±—É—Å',
        'BUS': '–ê–≤—Ç–æ–±—É—Å'
      };
      return typeNames[type] || type;
    }

    async function loadData() {
      try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
        const bookingsResponse = await fetch(`${API_BASE}/admin/bookings/active`);
        const bookingsData = await bookingsResponse.json();

        if (!bookingsResponse.ok || !bookingsData.success) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ${bookingsData.error || 'Unknown error'}`);
        }

        bookings = bookingsData.data || [];
        console.log('üìã –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:', bookings.length);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
        const vehiclesResponse = await fetch(`${API_BASE}/vehicles`);
        const vehiclesData = await vehiclesResponse.json();

        if (!vehiclesResponse.ok || !vehiclesData.success) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: ${vehiclesData.error || 'Unknown error'}`);
        }

        vehicles = vehiclesData.data || [];
        console.log('üöó –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:', vehicles.length);

        renderBookings();
        renderVehicles();

        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('bookingsContainer').style.display = 'block';
        document.getElementById('vehiclesContainer').style.display = 'block';

      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
      }
    }

    function renderBookings() {
      const container = document.getElementById('bookingsList');

      // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –±–µ–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
      const unassignedBookings = bookings.filter(booking => !booking.vehicle);

      if (unassignedBookings.length === 0) {
        container.innerHTML = '<p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –æ–∂–∏–¥–∞—é—â–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è</p>';
        return;
      }

      container.innerHTML = unassignedBookings.map(booking => `
                <div class="booking">
                    <h3>–ó–∞–∫–∞–∑ #${booking.id.slice(0, 8)}...</h3>
                    <div class="booking-info">
                        <div class="info-item">
                            <div class="info-label">–ú–∞—Ä—à—Ä—É—Ç:</div>
                            ${booking.fromLocation} ‚Üí ${booking.toLocation}
                        </div>
                        <div class="info-item">
                            <div class="info-label">–¢–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</div>
                            ${getVehicleTypeName(booking.vehicleType || 'SEDAN')}
                        </div>
                        <div class="info-item">
                            <div class="info-label">–°—Ç–∞—Ç—É—Å:</div>
                            ${booking.status}
                        </div>
                        <div class="info-item">
                            <div class="info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                            ${Number(booking.price).toLocaleString()} —Å—É–º
                        </div>
                        <div class="info-item">
                            <div class="info-label">–ö–ª–∏–µ–Ω—Ç:</div>
                            ${booking.user?.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </div>
                        <div class="info-item">
                            <div class="info-label">–°–æ–∑–¥–∞–Ω:</div>
                            ${new Date(booking.createdAt).toLocaleString('ru-RU')}
                        </div>
                    </div>
                    <button class="assign-btn" onclick="showAvailableVehicles('${booking.id}', '${booking.vehicleType}')">
                        üöó –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
                    </button>
                </div>
            `).join('');
    }

    function renderVehicles() {
      const container = document.getElementById('vehiclesList');

      container.innerHTML = vehicles.map(vehicle => `
                <div class="vehicle-card">
                    <h4>${vehicle.name}</h4>
                    <div class="vehicle-info">
                        <strong>–¢–∏–ø:</strong> ${getVehicleTypeName(vehicle.type)}
                    </div>
                    <div class="vehicle-info">
                        <strong>–ú–∞—Ä–∫–∞:</strong> ${vehicle.brand || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                    </div>
                    <div class="vehicle-info">
                        <strong>–ú–æ–¥–µ–ª—å:</strong> ${vehicle.model || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                    </div>
                    <div class="vehicle-info">
                        <strong>–ù–æ–º–µ—Ä:</strong> ${vehicle.licensePlate || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </div>
                    <div class="vehicle-info">
                        <strong>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</strong> ${vehicle.capacity} —á–µ–ª.
                    </div>
                    <div class="vehicle-info">
                        <strong>–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</strong> 
                        <span class="status-${vehicle.status?.toLowerCase()}">${vehicle.status}</span>
                    </div>
                    <div class="vehicle-info">
                        <strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> 
                        ${vehicle.driver ? `
                            ${vehicle.driver.name} 
                            (<span class="status-${vehicle.driver.status?.toLowerCase()}">${vehicle.driver.status}</span>)
                        ` : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}
                    </div>
                    <div class="vehicle-info">
                        <strong>–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:</strong> 
                        ${(vehicle.status === 'AVAILABLE' && vehicle.driver?.status === 'AVAILABLE') ?
          '<span class="status-available">‚úÖ –î–∞</span>' :
          '<span class="status-busy">‚ùå –ù–µ—Ç</span>'
        }
                    </div>
                </div>
            `).join('');
    }

    function showAvailableVehicles(bookingId, requiredType) {
      console.log(`üîç –ò—â–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${bookingId}, —Ç–∏–ø: ${requiredType}`);

      // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∫–∞–∫ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
      const availableVehicles = vehicles.filter(v =>
        v.status === 'AVAILABLE' &&
        v.driver?.status === 'AVAILABLE' &&
        (!requiredType || v.type === requiredType)
      );

      console.log('‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:', availableVehicles.length);
      console.log('üìã –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏:', availableVehicles);

      if (availableVehicles.length === 0) {
        document.getElementById('errorMessage').textContent =
          `–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Ç–∏–ø–∞ "${getVehicleTypeName(requiredType)}" —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º –≤–æ–¥–∏—Ç–µ–ª–µ–º`;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      } else {
        document.getElementById('successMessage').innerHTML = `
                    <strong>–ù–∞–π–¥–µ–Ω–æ ${availableVehicles.length} –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Ç–∏–ø–∞ "${getVehicleTypeName(requiredType)}":</strong><br>
                    ${availableVehicles.map(v =>
          `‚Ä¢ ${v.name} (${v.brand} ${v.model}, ${v.licensePlate}) - –í–æ–¥–∏—Ç–µ–ª—å: ${v.driver.name}`
        ).join('<br>')}
                `;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
      }

      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
      document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', loadData);
  </script>
</body>

</html>
