<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8 text-center">üöó –¢–µ—Å—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∫ –∑–∞–∫–∞–∑–∞–º</h1>

    <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div id="connectionStatus" class="mb-6 p-4 rounded-lg">
      <div class="flex items-center">
        <div class="loading w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full mr-2"></div>
        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API...</span>
      </div>
    </div>

    <!-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">üìù –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input type="text" id="fromLocation" placeholder="–û—Ç–∫—É–¥–∞" value="–¢–∞—à–∫–µ–Ω—Ç" class="border rounded px-3 py-2">
        <input type="text" id="toLocation" placeholder="–ö—É–¥–∞" value="–°–∞–º–∞—Ä–∫–∞–Ω–¥" class="border rounded px-3 py-2">
        <select id="vehicleType" class="border rounded px-3 py-2">
          <option value="SEDAN">–°–µ–¥–∞–Ω</option>
          <option value="PREMIUM">–ü—Ä–µ–º–∏—É–º</option>
          <option value="MINIVAN">–ú–∏–Ω–∏–≤—ç–Ω</option>
          <option value="MICROBUS">–ú–∏–∫—Ä–æ–∞–≤—Ç–æ–±—É—Å</option>
        </select>
        <input type="number" id="telegramId" placeholder="Telegram ID" value="123456789"
          class="border rounded px-3 py-2">
      </div>
      <button onclick="createTestBooking()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
      </button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
        <button onclick="loadBookings()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
      <div id="bookingsList" class="space-y-4">
        <!-- –ó–∞–∫–∞–∑—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">üöô –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</h2>
        <button onclick="loadVehicles()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
      <div id="vehiclesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
      </div>
    </div>

    <!-- –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <div class="bg-gray-900 text-green-400 rounded-lg p-4 mt-6">
      <h3 class="text-lg font-semibold mb-2">üìä –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
      <div id="operationLog" class="text-sm font-mono max-h-60 overflow-y-auto">
        <!-- –õ–æ–≥ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let bookings = [];
    let vehicles = [];

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    function log(message, type = 'info') {
      const logElement = document.getElementById('operationLog');
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: 'text-green-400',
        error: 'text-red-400',
        success: 'text-blue-400',
        warning: 'text-yellow-400'
      };
      logElement.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API
    async function checkConnection() {
      try {
        const response = await fetch(`${API_BASE}/bookings/active`);
        const data = await response.json();

        document.getElementById('connectionStatus').innerHTML = `
                    <div class="flex items-center text-green-600">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API —É—Å–ø–µ—à–Ω–æ</span>
                    </div>
                `;
        log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API —É—Å–ø–µ—à–Ω–æ', 'success');
        return true;
      } catch (error) {
        document.getElementById('connectionStatus').innerHTML = `
                    <div class="flex items-center text-red-600">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</span>
                    </div>
                `;
        log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API: ${error.message}`, 'error');
        return false;
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
    async function createTestBooking() {
      const fromLocation = document.getElementById('fromLocation').value;
      const toLocation = document.getElementById('toLocation').value;
      const vehicleType = document.getElementById('vehicleType').value;
      const telegramId = parseInt(document.getElementById('telegramId').value);

      if (!fromLocation || !toLocation || !telegramId) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }

      try {
        log(`üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞: ${fromLocation} ‚Üí ${toLocation}`, 'info');

        const response = await fetch(`${API_BASE}/bookings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            telegramId,
            fromLocation,
            toLocation,
            vehicleType,
            distanceKm: 280
          }),
        });

        const data = await response.json();

        if (data.success) {
          log(`‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ: ID ${data.data.id}`, 'success');
          await loadBookings();
        } else {
          log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ${error.message}`, 'error');
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    async function loadBookings() {
      try {
        log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...', 'info');

        const response = await fetch(`${API_BASE}/bookings/active`);
        const data = await response.json();

        if (data.success) {
          bookings = data.data || [];
          renderBookings();
          log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${bookings.length} –∑–∞–∫–∞–∑–æ–≤`, 'success');
        } else {
          log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤: ${error.message}`, 'error');
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
    async function loadVehicles() {
      try {
        log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π...', 'info');

        const response = await fetch(`${API_BASE}/vehicles`);
        const data = await response.json();

        if (data.success) {
          vehicles = data.data || [];
          renderVehicles();
          log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π`, 'success');
        } else {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
          vehicles = [
            {
              id: '1',
              brand: 'Kia',
              model: 'Carnival',
              type: 'MINIVAN',
              capacity: 8,
              licensePlate: '01 A 123 BC',
              status: 'AVAILABLE',
              driver: {
                id: '1',
                name: '–ò–±—Ä–∞–≥–∏–º –ê–∑–∏–∑–æ–≤',
                phone: '+998 90 123 45 67',
                status: 'AVAILABLE'
              }
            },
            {
              id: '2',
              brand: 'Mercedes',
              model: 'Sprinter',
              type: 'MICROBUS',
              capacity: 16,
              licensePlate: '01 B 456 CD',
              status: 'AVAILABLE',
              driver: {
                id: '2',
                name: '–ê–∑–∏–∑ –†–∞—Ö–∏–º–æ–≤',
                phone: '+998 91 234 56 78',
                status: 'AVAILABLE'
              }
            }
          ];
          renderVehicles();
          log(`‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π`, 'warning');
        }
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: ${error.message}`, 'error');
      }
    }

    // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∫ –∑–∞–∫–∞–∑—É
    async function assignVehicle(bookingId, vehicleId) {
      try {
        log(`üîÑ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è ${vehicleId} –∫ –∑–∞–∫–∞–∑—É ${bookingId}...`, 'info');

        const response = await fetch(`${API_BASE}/bookings/${bookingId}/assign-vehicle`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ vehicleId }),
        });

        const data = await response.json();

        if (data.success) {
          log(`‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª—å —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –∫ –∑–∞–∫–∞–∑—É`, 'success');
          await loadBookings();
          await loadVehicles();
        } else {
          log(`‚ùå –û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è: ${error.message}`, 'error');
      }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–∫–∞–∑–æ–≤
    function renderBookings() {
      const container = document.getElementById('bookingsList');

      if (bookings.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>';
        return;
      }

      container.innerHTML = bookings.map(booking => `
                <div class="border rounded-lg p-4 ${booking.status === 'PENDING' ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-semibold text-lg">${booking.fromLocation} ‚Üí ${booking.toLocation}</div>
                            <div class="text-sm text-gray-600">ID: ${booking.id}</div>
                            <div class="text-sm text-gray-600">–°—Ç–∞—Ç—É—Å: ${getStatusText(booking.status)}</div>
                            <div class="text-sm text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${Number(booking.price).toLocaleString()} —Å—É–º</div>
                            ${booking.vehicle ? `
                                <div class="text-sm text-green-600 mt-2">
                                    üöó ${booking.vehicle.brand} ${booking.vehicle.model} (${booking.vehicle.licensePlate})
                                    ${booking.driver ? `<br>üë§ –í–æ–¥–∏—Ç–µ–ª—å: ${booking.driver.name}` : ''}
                                </div>
                            ` : `
                                <div class="text-sm text-orange-600 mt-2">
                                    üöó –¢—Ä–µ–±—É–µ—Ç—Å—è: ${getVehicleTypeName(booking.vehicleType || 'SEDAN')}
                                    <br><span class="text-xs text-gray-500">–û–∂–∏–¥–∞–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</span>
                                </div>
                            `}
                        </div>
                        <div class="flex flex-col space-y-2">
                            ${booking.status === 'PENDING' ? `
                                <select id="vehicleSelect_${booking.id}" class="text-sm border rounded px-2 py-1">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                                    ${vehicles.filter(v => v.status === 'AVAILABLE').map(v =>
        `<option value="${v.id}">${v.brand} ${v.model} (${v.licensePlate})</option>`
      ).join('')}
                                </select>
                                <button onclick="assignVehicleFromSelect('${booking.id}')" 
                                        class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
    }

    // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function assignVehicleFromSelect(bookingId) {
      const select = document.getElementById(`vehicleSelect_${bookingId}`);
      const vehicleId = select.value;

      if (!vehicleId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å');
        return;
      }

      assignVehicle(bookingId, vehicleId);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
    function renderVehicles() {
      const container = document.getElementById('vehiclesList');

      if (vehicles.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-2">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</p>';
        return;
      }

      container.innerHTML = vehicles.map(vehicle => `
                <div class="border rounded-lg p-4 ${vehicle.status === 'AVAILABLE' ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'}">
                    <div class="font-semibold">${vehicle.brand} ${vehicle.model}</div>
                    <div class="text-sm text-gray-600">–ù–æ–º–µ—Ä: ${vehicle.licensePlate}</div>
                    <div class="text-sm text-gray-600">–¢–∏–ø: ${vehicle.type}</div>
                    <div class="text-sm text-gray-600">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${vehicle.capacity} —á–µ–ª.</div>
                    <div class="text-sm ${vehicle.status === 'AVAILABLE' ? 'text-green-600' : 'text-red-600'}">
                        –°—Ç–∞—Ç—É—Å: ${vehicle.status === 'AVAILABLE' ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ó–∞–Ω—è—Ç'}
                    </div>
                    ${vehicle.driver ? `
                        <div class="text-sm text-blue-600 mt-2">
                            üë§ ${vehicle.driver.name}<br>
                            üìû ${vehicle.driver.phone}
                        </div>
                    ` : ''}
                </div>
            `).join('');
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
    function getStatusText(status) {
      const statusMap = {
        'PENDING': '–û–∂–∏–¥–∞–µ—Ç',
        'CONFIRMED': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
        'IN_PROGRESS': '–í –ø—É—Ç–∏',
        'COMPLETED': '–ó–∞–≤–µ—Ä—à–µ–Ω',
        'CANCELLED': '–û—Ç–º–µ–Ω–µ–Ω'
      };
      return statusMap[status] || status;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
    function getVehicleTypeName(vehicleType) {
      const typeMap = {
        'SEDAN': '–°–µ–¥–∞–Ω',
        'PREMIUM': '–ü—Ä–µ–º–∏—É–º',
        'MINIVAN': '–ú–∏–Ω–∏–≤—ç–Ω',
        'MICROBUS': '–ú–∏–∫—Ä–æ–∞–≤—Ç–æ–±—É—Å',
        'BUS': '–ê–≤—Ç–æ–±—É—Å'
      };
      return typeMap[vehicleType] || vehicleType;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = async function () {
      log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...', 'info');

      const connected = await checkConnection();
      if (connected) {
        await loadBookings();
        await loadVehicles();
      }

      log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
    };
  </script>
</body>

</html>