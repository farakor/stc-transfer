<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ç–ª–∞–¥–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ - STC Transfer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-900">
      üîç –û—Ç–ª–∞–¥–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    </h1>

    <!-- –¢–µ—Å—Ç—ã API -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- –¢–µ—Å—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">üìã –¢–µ—Å—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h2>
        <button onclick="testActiveBookings()"
          class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mb-4">
          –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        </button>
        <div id="activeBookingsResult" class="text-sm"></div>
      </div>

      <!-- –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">‚ûï –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞</h2>
        <button onclick="testCreateBooking()"
          class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 mb-4">
          –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
        </button>
        <div id="createBookingResult" class="text-sm"></div>
      </div>

      <!-- –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">üìä –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h2>
        <button onclick="testStats()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 mb-4">
          –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        </button>
        <div id="statsResult" class="text-sm"></div>
      </div>

      <!-- –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">üåê –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</h2>
        <button onclick="testConnection()"
          class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 mb-4">
          –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        </button>
        <div id="connectionResult" class="text-sm"></div>
      </div>
    </div>

    <!-- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
      <h2 class="text-xl font-semibold mb-4">üìù –õ–æ–≥–∏</h2>
      <button onclick="clearLogs()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 mb-4">
        –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
      </button>
      <div id="logs" class="bg-gray-900 text-green-400 p-4 rounded-md font-mono text-sm h-64 overflow-y-auto"></div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Ä—Ç–∞—Ö -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
      <h3 class="text-lg font-semibold text-yellow-800 mb-2">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
      <div class="text-sm text-yellow-700">
        <p><strong>–¢–µ–∫—É—â–∏–π URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>API Base:</strong> <span id="apiBase"></span></p>
        <p><strong>Backend –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞:</strong> http://localhost:3001</p>
        <p><strong>Frontend –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞:</strong> http://localhost:3000 –∏–ª–∏ http://localhost:3003</p>
      </div>
    </div>
  </div>

  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const API_BASES = [
      '/api',                     // –ß–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
      'http://localhost:3001/api', // –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    ];

    let currentApiBase = API_BASES[0];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('currentUrl').textContent = window.location.href;
      document.getElementById('apiBase').textContent = currentApiBase;
      log('üöÄ –û—Ç–ª–∞–¥—á–∏–∫ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ –∑–∞–ø—É—â–µ–Ω');
      log(`üìç –¢–µ–∫—É—â–∏–π URL: ${window.location.href}`);
      log(`üîó API Base: ${currentApiBase}`);
    });

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    function log(message) {
      const logsDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è fetch —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    async function fetchWithLogging(url, options = {}) {
      log(`üåê –ó–∞–ø—Ä–æ—Å: ${options.method || 'GET'} ${url}`);

      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        log(`‚úÖ –û—Ç–≤–µ—Ç: ${response.status} ${response.statusText}`);

        const data = await response.json();
        log(`üì¶ –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(data, null, 2)}`);

        return { response, data };
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        throw error;
      }
    }

    // –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    async function testConnection() {
      const resultDiv = document.getElementById('connectionResult');
      resultDiv.innerHTML = '<div class="text-blue-600">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</div>';

      for (const apiBase of API_BASES) {
        try {
          log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞: ${apiBase}`);

          const { response, data } = await fetchWithLogging(`${apiBase}/bookings/active`);

          if (response.ok && data.success) {
            resultDiv.innerHTML += `
                            <div class="text-green-600 mb-2">‚úÖ ${apiBase} - OK</div>
                            <div class="text-sm text-gray-600">–ù–∞–π–¥–µ–Ω–æ ${data.data?.length || 0} –∑–∞–∫–∞–∑–æ–≤</div>
                        `;
            currentApiBase = apiBase;
            document.getElementById('apiBase').textContent = currentApiBase;
            break;
          } else {
            resultDiv.innerHTML += `<div class="text-red-600">‚ùå ${apiBase} - –û—à–∏–±–∫–∞ API</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML += `<div class="text-red-600">‚ùå ${apiBase} - ${error.message}</div>`;
        }
      }
    }

    // –¢–µ—Å—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    async function testActiveBookings() {
      const resultDiv = document.getElementById('activeBookingsResult');
      resultDiv.innerHTML = '<div class="text-blue-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

      try {
        const { response, data } = await fetchWithLogging(`${currentApiBase}/bookings/active`);

        if (data.success && data.data) {
          resultDiv.innerHTML = `
                        <div class="text-green-600 mb-2">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.data.length} –∑–∞–∫–∞–∑–æ–≤</div>
                        <div class="space-y-2">
                            ${data.data.map(booking => `
                                <div class="bg-gray-50 p-2 rounded text-xs">
                                    <div><strong>ID:</strong> ${booking.id.slice(0, 8)}...</div>
                                    <div><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${booking.fromLocation} ‚Üí ${booking.toLocation}</div>
                                    <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${booking.status}</div>
                                    <div><strong>–¶–µ–Ω–∞:</strong> ${booking.price} —Å—É–º</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
        } else {
          resultDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
      }
    }

    // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
    async function testCreateBooking() {
      const resultDiv = document.getElementById('createBookingResult');
      resultDiv.innerHTML = '<div class="text-blue-600">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...</div>';

      try {
        const { response, data } = await fetchWithLogging(`${currentApiBase}/bookings`, {
          method: 'POST',
          body: JSON.stringify({
            telegramId: Math.floor(Math.random() * 1000000),
            fromLocation: '–°–∞–º–∞—Ä–∫–∞–Ω–¥',
            toLocation: '–¢–∞—à–∫–µ–Ω—Ç',
            vehicleType: 'SEDAN',
            notes: '–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ –æ—Ç–ª–∞–¥—á–∏–∫–∞',
            distanceKm: 280
          })
        });

        if (data.success) {
          resultDiv.innerHTML = `
                        <div class="text-green-600 mb-2">‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω</div>
                        <div class="bg-gray-50 p-2 rounded text-xs">
                            <div><strong>ID:</strong> ${data.data.id}</div>
                            <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.data.status}</div>
                            <div><strong>–¶–µ–Ω–∞:</strong> ${data.data.price} —Å—É–º</div>
                        </div>
                    `;

          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
          setTimeout(testActiveBookings, 1000);
        } else {
          resultDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
      }
    }

    // –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function testStats() {
      const resultDiv = document.getElementById('statsResult');
      resultDiv.innerHTML = '<div class="text-blue-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>';

      try {
        const { response, data } = await fetchWithLogging(`${currentApiBase}/bookings/stats`);

        if (data.success) {
          resultDiv.innerHTML = `
                        <div class="text-green-600 mb-2">‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>
                        <div class="bg-gray-50 p-2 rounded text-xs">
                            <div><strong>–°—Ç–∞—Ç—É—Å—ã:</strong> ${data.data.statusStats?.length || 0} –∑–∞–ø–∏—Å–µ–π</div>
                            <div><strong>–í—ã—Ä—É—á–∫–∞:</strong> ${data.data.totalRevenue || 0} —Å—É–º</div>
                            <div><strong>–ü–æ —Ç–∏–ø–∞–º –¢–°:</strong> ${data.data.vehicleTypeStats?.length || 0} –∑–∞–ø–∏—Å–µ–π</div>
                        </div>
                    `;
        } else {
          resultDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
      }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(testConnection, 1000);
  </script>
</body>

</html>