<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ –¢–µ—Å—Ç Telegram Bot - STC Transfer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .info-item span {
            color: #333;
            font-size: 1.1em;
        }

        .test-section {
            margin-top: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result pre {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9em;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .bot-link {
            display: inline-block;
            background: #0088cc;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: background 0.3s;
        }

        .bot-link:hover {
            background: #006699;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ –¢–µ—Å—Ç Telegram Bot</h1>
            <p>STC Transfer - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</p>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞ -->
        <div class="card">
            <h2>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
            <button class="refresh-btn" onclick="checkStatus()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            
            <div class="info-grid">
                <div class="info-item">
                    <strong>Backend Server</strong>
                    <span id="backend-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div class="info-item">
                    <strong>Telegram Bot</strong>
                    <span id="bot-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div class="info-item">
                    <strong>Webhook</strong>
                    <span id="webhook-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div class="info-item">
                    <strong>ngrok</strong>
                    <span id="ngrok-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
            </div>

            <div id="bot-info" style="margin-top: 20px;">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>

        <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="card">
            <h2>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
            <div class="test-section">
                <div class="form-group">
                    <label for="chatId">Chat ID (Telegram User ID)</label>
                    <input type="number" id="chatId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        üí° –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Chat ID, –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É @userinfobot
                    </small>
                </div>

                <div class="form-group">
                    <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                    <textarea id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...">üéâ –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç STC Transfer Bot!</textarea>
                </div>

                <button onclick="sendTestMessage()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                <div id="message-result" class="result"></div>
            </div>
        </div>

        <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="card">
            <h2>üöó –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–∫–∞–∑–µ</h2>
            <div class="test-section">
                <div class="form-group">
                    <label for="bookingChatId">Chat ID –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="number" id="bookingChatId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789">
                </div>

                <div class="form-group">
                    <label for="bookingFrom">–û—Ç–∫—É–¥–∞</label>
                    <input type="text" id="bookingFrom" value="–°–∞–º–∞—Ä–∫–∞–Ω–¥">
                </div>

                <div class="form-group">
                    <label for="bookingTo">–ö—É–¥–∞</label>
                    <input type="text" id="bookingTo" value="–¢–∞—à–∫–µ–Ω—Ç">
                </div>

                <div class="form-group">
                    <label for="vehicleType">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</label>
                    <input type="text" id="vehicleType" value="–°–µ–¥–∞–Ω">
                </div>

                <div class="form-group">
                    <label for="price">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Å—É–º)</label>
                    <input type="number" id="price" value="350000">
                </div>

                <button onclick="sendBookingNotification()">üöó –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–∫–∞–∑–µ</button>
                <div id="booking-result" class="result"></div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ -->
        <div class="card">
            <h2>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <p style="margin-bottom: 15px;">
                <strong>Telegram Bot:</strong> @transfer_srs_bot<br>
                <a href="https://t.me/transfer_srs_bot" target="_blank" class="bot-link">
                    ü§ñ –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram
                </a>
            </p>

            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h3>
            <ol style="line-height: 2;">
                <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω (<code>cd backend && npm run dev</code>)</li>
                <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ ngrok (<code>ngrok http 3001</code>)</li>
                <li>–£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π Chat ID —á–µ—Ä–µ–∑ –±–æ—Ç–∞ @userinfobot</li>
                <li>–í–≤–µ–¥–∏—Ç–µ Chat ID –≤ —Ñ–æ—Ä–º—É –≤—ã—à–µ</li>
                <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</li>
            </ol>

            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</h3>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;">
# –ó–∞–ø—É—Å—Ç–∏—Ç—å Telegram Bot
./start-telegram-bot.sh

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
./check-bot-status.sh

# Backend
cd backend && npm run dev

# ngrok
ngrok http 3001
            </pre>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
        async function checkStatus() {
            // Backend
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                document.getElementById('backend-status').innerHTML = 
                    '<span class="status-badge active">‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç</span>';
            } catch (error) {
                document.getElementById('backend-status').innerHTML = 
                    '<span class="status-badge inactive">‚ùå –ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç</span>';
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ backend API (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
            document.getElementById('bot-status').innerHTML = 
                '<span class="status-badge active">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>';
            document.getElementById('webhook-status').innerHTML = 
                '<span class="status-badge active">‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>';
            
            // ngrok
            try {
                const ngrokResponse = await fetch('http://localhost:4040/api/tunnels');
                const ngrokData = await ngrokResponse.json();
                const publicUrl = ngrokData.tunnels.find(t => t.proto === 'https')?.public_url;
                
                if (publicUrl) {
                    document.getElementById('ngrok-status').innerHTML = 
                        `<span class="status-badge active">‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç</span><br><small>${publicUrl}</small>`;
                } else {
                    document.getElementById('ngrok-status').innerHTML = 
                        '<span class="status-badge inactive">‚ùå –ù–µ –∑–∞–ø—É—â–µ–Ω</span>';
                }
            } catch (error) {
                document.getElementById('ngrok-status').innerHTML = 
                    '<span class="status-badge inactive">‚ùå –ù–µ –∑–∞–ø—É—â–µ–Ω</span>';
            }

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
            document.getElementById('bot-info').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <strong>ü§ñ –ò–º—è –±–æ—Ç–∞:</strong> SRS Transfer<br>
                    <strong>üë§ Username:</strong> @transfer_srs_bot<br>
                    <strong>üîó –°—Å—ã–ª–∫–∞:</strong> <a href="https://t.me/transfer_srs_bot" target="_blank">https://t.me/transfer_srs_bot</a>
                </div>
            `;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendTestMessage() {
            const chatId = document.getElementById('chatId').value;
            const message = document.getElementById('message').value;
            const resultDiv = document.getElementById('message-result');

            if (!chatId) {
                showResult(resultDiv, false, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ Chat ID');
                return;
            }

            if (!message) {
                showResult(resultDiv, false, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }

            try {
                // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞ backend
                const response = await fetch(`${API_URL}/api/admin/send-test-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ chatId: parseInt(chatId), message })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(resultDiv, true, `‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!`, data);
                } else {
                    const error = await response.json();
                    showResult(resultDiv, false, `‚ùå –û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, error);
                }
            } catch (error) {
                showResult(resultDiv, false, `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ
        async function sendBookingNotification() {
            const chatId = document.getElementById('bookingChatId').value;
            const resultDiv = document.getElementById('booking-result');

            if (!chatId) {
                showResult(resultDiv, false, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ Chat ID');
                return;
            }

            const bookingData = {
                chatId: parseInt(chatId),
                bookingData: {
                    fromLocation: document.getElementById('bookingFrom').value,
                    toLocation: document.getElementById('bookingTo').value,
                    vehicleType: document.getElementById('vehicleType').value,
                    price: document.getElementById('price').value
                }
            };

            try {
                const response = await fetch(`${API_URL}/api/admin/send-booking-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(resultDiv, true, `‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–∫–∞–∑–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!`, data);
                } else {
                    const error = await response.json();
                    showResult(resultDiv, false, `‚ùå –û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, error);
                }
            } catch (error) {
                showResult(resultDiv, false, `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(element, success, message, data = null) {
            element.className = `result ${success ? 'success' : 'error'}`;
            element.style.display = 'block';
            
            let html = `<strong>${message}</strong>`;
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            element.innerHTML = html;
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = checkStatus;
    </script>
</body>
</html>

