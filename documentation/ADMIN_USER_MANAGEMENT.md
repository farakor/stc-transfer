# Документация по управлению администраторами

## Обзор

Реализована полноценная система управления пользователями (администраторами) с аутентификацией через JWT токены, различными ролями и правами доступа.

## Суперадминистратор

Создан суперадминистратор с полными правами доступа:

**Учетные данные:**

- **Email:** farrukh.oripov@gmail.com
- **Пароль:** eNL+i6wQ$56Kj?W
- **Роль:** SUPER_ADMIN

## Роли администраторов

### SUPER_ADMIN (Суперадминистратор)

- Полный доступ ко всем функциям системы
- Управление другими администраторами
- Создание, редактирование и удаление администраторов
- Изменение ролей пользователей

### ADMIN (Администратор)

- Управление заказами
- Управление водителями
- Управление автомобилями
- Просмотр и управление клиентами
- Доступ к аналитике

### MANAGER (Менеджер)

- Просмотр заказов
- Базовое управление заказами
- Просмотр водителей и автомобилей
- Ограниченный доступ к аналитике

### OPERATOR (Оператор)

- Только просмотр данных
- Нет прав на изменение
- Доступ к просмотру заказов, водителей, автомобилей

## Архитектура

### Backend

#### Модель базы данных (Prisma Schema)

```prisma
model Admin {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  password   String    // Захешированный пароль
  first_name String
  last_name  String
  role       AdminRole @default(ADMIN)
  is_active  Boolean   @default(true)
  last_login DateTime?
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  OPERATOR
}
```

#### Middleware аутентификации

- `authenticate` - проверка JWT токена
- `authorize(...roles)` - проверка прав доступа по ролям
- `optionalAuth` - опциональная аутентификация

#### Контроллеры и сервисы

- **AuthController** - обработка запросов аутентификации
- **AuthService** - бизнес-логика управления администраторами
- Хеширование паролей с использованием `crypto.pbkdf2Sync`

#### API эндпоинты

##### Публичные

- `POST /api/auth/login` - Вход администратора

##### Защищенные (требуют аутентификации)

- `GET /api/auth/profile` - Получить профиль текущего администратора
- `POST /api/auth/change-password` - Изменить пароль

##### Управление администраторами (только SUPER_ADMIN)

- `GET /api/auth/admins` - Получить всех администраторов
- `POST /api/auth/admins` - Создать администратора
- `PUT /api/auth/admins/:id` - Обновить администратора
- `DELETE /api/auth/admins/:id` - Удалить администратора

#### Защита административных маршрутов

Все административные маршруты теперь защищены:

```typescript
app.use(
  "/api/admin",
  authenticate,
  authorize(AdminRole.SUPER_ADMIN, AdminRole.ADMIN, AdminRole.MANAGER),
  adminRoutes
);
app.use(
  "/api/wialon",
  authenticate,
  authorize(AdminRole.SUPER_ADMIN, AdminRole.ADMIN),
  wialonRoutes
);
```

### Frontend

#### Страницы

1. **AdminLogin** (`/admin/login`) - Страница входа администратора
2. **AdminsManagement** (`/admin/admins`) - Управление администраторами

#### Сервисы

- **AuthService** - работа с API аутентификации
  - login() - вход
  - logout() - выход
  - getProfile() - получение профиля
  - changePassword() - изменение пароля
  - getAllAdmins() - получение списка администраторов
  - createAdmin() - создание администратора
  - updateAdmin() - обновление администратора
  - deleteAdmin() - удаление администратора

#### Компоненты

- Таблица администраторов с фильтрацией
- Модальные окна создания/редактирования
- Управление статусом активности
- Отображение ролей и последнего входа

## Использование

### Вход в систему

1. Перейдите на страницу входа: `http://localhost:3003/admin/login`
2. Введите учетные данные суперадминистратора:
   - Email: farrukh.oripov@gmail.com
   - Пароль: eNL+i6wQ$56Kj?W
3. После успешного входа вы будете перенаправлены на панель управления

### Управление администраторами

1. В боковом меню выберите "Администраторы"
2. Нажмите "+ Добавить администратора" для создания нового
3. Заполните форму:
   - Email
   - Пароль (минимум 8 символов)
   - Имя
   - Фамилия
   - Роль
4. Нажмите "Создать"

### Редактирование администратора

1. В таблице администраторов нажмите "Редактировать"
2. Измените необходимые поля
3. Пароль можно оставить пустым, если не нужно менять
4. Нажмите "Сохранить"

### Деактивация администратора

1. Нажмите "Деактивировать" напротив нужного администратора
2. Деактивированный администратор не сможет войти в систему
3. Для активации нажмите "Активировать"

### Удаление администратора

1. Нажмите "Удалить" напротив нужного администратора
2. Подтвердите удаление
3. **Примечание:** Нельзя удалить последнего SUPER_ADMIN

## Безопасность

### Хеширование паролей

Используется встроенный модуль Node.js `crypto`:

- Алгоритм: PBKDF2 с SHA-512
- Соль: 16 случайных байт
- Итерации: 1000
- Длина ключа: 64 байта

### JWT токены

- Секретный ключ: настраивается через `JWT_SECRET` в `.env`
- Время жизни: 24 часа (по умолчанию)
- Хранение: localStorage на клиенте
- Автоматическая верификация при каждом запросе

### Права доступа

- SUPER_ADMIN имеет доступ ко всему
- Роли проверяются на уровне middleware
- Неавторизованные запросы возвращают 401
- Недостаточные права возвращают 403

## Скрипты

### Создание суперадминистратора

```bash
cd backend
npm run create-super-admin
```

Скрипт автоматически:

- Проверяет существование администратора
- Создает нового или обновляет существующего
- Хеширует пароль
- Выводит данные для входа

### Миграция базы данных

```bash
cd backend
npm run db:generate  # Генерация Prisma Client
npm run db:migrate   # Применение миграций
```

## Переменные окружения

Добавьте в `backend/.env`:

```env
JWT_SECRET="your-super-secret-jwt-key-here"
JWT_EXPIRES_IN="24h"
```

## Структура файлов

### Backend

```
backend/src/
├── middleware/
│   └── auth.ts                 # JWT middleware
├── services/
│   └── authService.ts          # Сервис аутентификации
├── controllers/
│   └── authController.ts       # Контроллер аутентификации
├── routes/
│   └── auth.ts                 # Роуты аутентификации
└── utils/
    └── createSuperAdmin.ts     # Скрипт создания суперадмина
```

### Frontend

```
frontend/src/
├── services/
│   └── authService.ts          # API клиент
├── pages/admin/
│   ├── AdminLogin.tsx          # Страница входа
│   ├── AdminsManagement.tsx    # Управление администраторами
│   ├── AdminApp.tsx            # Главное приложение
│   └── AdminLayout.tsx         # Макет с меню
└── components/
    └── AppRoutes.tsx           # Роутинг
```

## Тестирование

### Тест входа

```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "farrukh.oripov@gmail.com",
    "password": "eNL+i6wQ$56Kj?W"
  }'
```

### Тест получения списка администраторов

```bash
curl -X GET http://localhost:3001/api/auth/admins \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### Тест создания администратора

```bash
curl -X POST http://localhost:3001/api/auth/admins \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "SecurePass123",
    "firstName": "Иван",
    "lastName": "Иванов",
    "role": "ADMIN"
  }'
```

## Возможные проблемы и решения

### Ошибка "Invalid token"

- Проверьте, что токен актуален (не истек)
- Убедитесь, что `JWT_SECRET` одинаковый при создании и проверке токена

### Ошибка "Admin account is deactivated"

- Проверьте статус `is_active` в базе данных
- Активируйте администратора через другого SUPER_ADMIN

### Ошибка "Insufficient permissions"

- Проверьте роль текущего пользователя
- Убедитесь, что роль имеет необходимые права

## Дальнейшее развитие

### Возможные улучшения:

1. Двухфакторная аутентификация (2FA)
2. История действий администраторов (audit log)
3. Восстановление пароля через email
4. Настройка времени жизни сессии
5. Блокировка после нескольких неудачных попыток входа
6. Уведомления о входе в систему
7. Управление правами на уровне отдельных действий

## Контакты

- **Разработчик:** Farrukh Oripov
- **Email:** farrukh.oripov@gmail.com
- **Организация:** Samarkand Touristic Centre

---

**Дата создания:** 12 октября 2024
**Версия:** 1.0.0
