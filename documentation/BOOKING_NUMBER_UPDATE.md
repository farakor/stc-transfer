# Обновление системы нумерации заказов

## Дата: 12 октября 2024

## Изменения

Изменена система нумерации заказов с UUID на читаемый формат **СТТ-00001**.

### Формат номера заказа

- **Префикс**: СТТ (аббревиатура компании)
- **Разделитель**: дефис (-)
- **Номер**: 5-значный с ведущими нулями (00001, 00002, ...)

**Примеры:**

- СТТ-00001
- СТТ-00023
- СТТ-00456
- СТТ-12345

## Технические детали

### База данных

Добавлены новые поля в таблицу `Booking`:

```sql
ALTER TABLE "Booking" ADD COLUMN "sequence_number" SERIAL;
ALTER TABLE "Booking" ADD COLUMN "booking_number" TEXT NOT NULL UNIQUE;
```

- `sequence_number` - автоинкрементный порядковый номер (1, 2, 3, ...)
- `booking_number` - форматированный номер заказа (СТТ-00001, СТТ-00002, ...)

### Backend

#### Prisma Schema

Обновлена модель `Booking`:

```prisma
model Booking {
  id               String        @id @default(cuid())
  booking_number   String        @unique
  sequence_number  Int           @unique @default(autoincrement())
  // ... остальные поля
}
```

#### BookingService

Добавлен метод генерации номера заказа:

```typescript
private static generateBookingNumber(sequenceNumber: number): string {
  const paddedNumber = sequenceNumber.toString().padStart(5, '0')
  return `СТТ-${paddedNumber}`
}
```

При создании заказа номер генерируется автоматически на основе `sequence_number`.

#### BookingDetails Interface

Добавлено поле `bookingNumber`:

```typescript
export interface BookingDetails {
  id: string;
  bookingNumber: string; // Новое поле
  status: BookingStatus;
  // ... остальные поля
}
```

### Frontend

#### Types

Обновлен интерфейс `Booking`:

```typescript
export interface Booking {
  id: string;
  bookingNumber: string; // Новое поле
  // ... остальные поля
}
```

#### Компоненты

Обновлены следующие компоненты для отображения нового номера:

1. **BookingCard** - отображает номер заказа вместо сокращенного ID
2. **BookingStatus** - заголовок с номером заказа
3. **TrackingPage** - отображение номера заказа в информации
4. **BookingsManagement** (админка) - таблица с номерами заказов

## Миграция данных

Для существующих заказов номера были автоматически сгенерированы при применении миграции:

```sql
UPDATE "Booking"
SET "booking_number" = 'СТТ-' || LPAD(sequence_number::text, 5, '0')
WHERE "booking_number" IS NULL;
```

## Обратная совместимость

- Внутренний `id` (UUID) сохранен для использования в API и ссылках
- `bookingNumber` используется только для отображения пользователям
- Все существующие API endpoints продолжают работать с `id`

## Преимущества

1. **Удобочитаемость**: Легко запомнить и продиктовать номер заказа
2. **Профессиональный вид**: Единый формат нумерации
3. **Идентификация**: Префикс СТТ сразу идентифицирует заказ компании
4. **Отслеживание**: Порядковые номера позволяют оценить количество заказов

## Тестирование

После применения изменений необходимо протестировать:

1. ✅ Создание нового заказа
2. ✅ Отображение номера в карточке заказа
3. ✅ Отображение номера на странице статуса
4. ✅ Отображение номера в админской панели
5. ✅ Отображение номера на странице отслеживания

## Примечания

- Номера заказов начинаются с СТТ-00001
- Нумерация последовательная и не имеет пропусков
- При удалении заказа номер не используется повторно
